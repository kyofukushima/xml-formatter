# 機能要件定義書

## 文書情報

- **文書名**: XML変換パイプライン処理システム Webアプリ化 機能要件定義書
- **バージョン**: 1.0
- **作成日**: 2025年1月
- **目的**: 技術的な実装方法に依存しない、純粋な機能要件の定義

---

## 目次

1. [概要](#概要)
2. [用語定義](#用語定義)
3. [システム全体像](#システム全体像)
4. [機能要件一覧](#機能要件一覧)
5. [詳細機能仕様](#詳細機能仕様)
6. [ユーザーストーリー](#ユーザーストーリー)
7. [非機能要件](#非機能要件)
8. [制約事項](#制約事項)

---

## 概要

### 目的

本システムは、教育課程関連のXMLファイルを階層構造に整形するパイプライン処理を、Webアプリケーションとして提供することを目的とします。

### 背景

現在、コマンドラインスクリプトとして実装されているXML変換パイプライン処理を、より使いやすいWebアプリケーションとして提供することで、技術的な知識がなくても利用できるようにします。

### 対象ユーザー

- **主要ユーザー**: 教育課程関連のXMLファイルを処理する必要がある業務担当者
- **技術レベル**: 基本的なPC操作ができる（XMLの技術的知識は不要）

---

## 用語定義

| 用語 | 定義 |
|------|------|
| **XMLファイル** | 処理対象となる教育課程関連のXML形式ファイル |
| **変換スクリプト** | XMLファイルを変換するためのPythonスクリプト（15個存在） |
| **パイプライン処理** | 複数の変換スクリプトを順次実行する処理 |
| **中間ファイル** | パイプライン処理の各ステップで生成される中間的なXMLファイル |
| **最終出力ファイル** | パイプライン処理が完了した後の最終的なXMLファイル |
| **構文検証** | XMLファイルが正しい形式（well-formed）かどうかをチェックする処理 |
| **テキスト内容検証** | 元のXMLファイルと処理後のXMLファイルのテキスト内容が一致しているかを確認する処理 |
| **検証レポート** | 検証処理の結果を記録したテキストファイル |
| **処理履歴** | 過去に実行した処理の記録（ファイル名、実行日時、使用したスクリプトなど） |
| **ラベル設定** | XMLファイル内のラベルパターンを認識するための設定（`label_config.json`） |
| **ラベル定義** | ラベルパターンの定義（ID、名前、正規表現パターン、例、説明） |
| **パターン優先度** | ラベルパターンの優先順位リスト |
| **階層ルール** | XML要素の階層処理に関するルール設定 |
| **変換動作** | XML変換時の動作設定（Column処理、リスト分割モードなど） |

---

## システム全体像

### システムの役割

1. **XMLファイルの受付**: ユーザーがXMLファイルをアップロード
2. **処理設定**: 実行する変換スクリプトの選択
3. **ラベル設定の管理**: ラベルパターン認識のための設定の編集・管理（オプション）
4. **パイプライン処理の実行**: 選択したスクリプトを順次実行
5. **検証処理**: 処理前後の検証を実行
6. **結果の提供**: 処理済みXMLファイルと検証レポートの提供

### 処理フロー概要

```
[ユーザー] 
  ↓ ファイルアップロード
[システム] 
  ↓ 構文検証
[システム] 
  ↓ パイプライン処理（選択したスクリプトを順次実行）
[システム] 
  ↓ テキスト内容検証
[システム] 
  ↓ 結果の提供
[ユーザー] 
  ↓ ダウンロード
```

---

## 機能要件一覧

### 優先度の定義

- **P0（必須）**: システムの基本機能として必須
- **P1（重要）**: ユーザビリティ向上に重要だが、なくても動作する
- **P2（推奨）**: あると便利だが、なくても問題ない
- **P3（将来）**: 将来的に検討すべき機能

### 機能要件マトリクス

| 機能ID | 機能名 | 優先度 | フェーズ |
|--------|--------|--------|---------|
| FR-001 | XMLファイルのアップロード | P0 | Phase 1 |
| FR-002 | 変換スクリプトの選択 | P0 | Phase 1 |
| FR-003 | パイプライン処理の実行 | P0 | Phase 1 |
| FR-004 | 処理済みXMLファイルのダウンロード | P0 | Phase 1 |
| FR-005 | 処理進捗の表示 | P0 | Phase 1 |
| FR-006 | エラーメッセージの表示 | P0 | Phase 1 |
| FR-007 | 構文検証の実行 | P0 | Phase 1 |
| FR-008 | テキスト内容検証の実行 | P0 | Phase 1 |
| FR-009 | 検証レポートの表示 | P0 | Phase 1 |
| FR-010 | XMLファイルのプレビュー | P1 | Phase 1 |
| FR-011 | 中間ファイルのダウンロード | P1 | Phase 1 |
| FR-012 | 処理履歴の保存 | P1 | Phase 2 |
| FR-013 | 処理履歴の表示 | P1 | Phase 2 |
| FR-014 | 設定の保存 | P1 | Phase 2 |
| FR-015 | 複数ファイルの一括アップロード | P2 | Phase 2 |
| FR-016 | バッチ処理の実行 | P2 | Phase 2 |
| FR-017 | バッチ処理の進捗表示 | P2 | Phase 2 |
| FR-018 | 処理結果の比較 | P2 | Phase 2 |
| FR-019 | 設定プロファイルの保存 | P2 | Phase 2 |
| FR-020 | ユーザー認証 | P3 | Phase 3 |
| FR-021 | 処理キュー管理 | P3 | Phase 3 |
| FR-022 | 通知機能 | P3 | Phase 3 |
| FR-023 | ラベル設定の表示 | P1 | Phase 1 |
| FR-024 | ラベル設定の編集 | P1 | Phase 1 |
| FR-025 | ラベル設定の保存 | P1 | Phase 1 |
| FR-026 | ラベル設定のインポート/エクスポート | P2 | Phase 1 |
| FR-027 | ラベル設定のバリデーション | P1 | Phase 1 |
| FR-028 | ラベル設定のプレビュー/テスト | P2 | Phase 2 |
| FR-029 | ブーリアン型パラメーターの簡易設定 | P1 | Phase 1 |

---

## 詳細機能仕様

### FR-001: XMLファイルのアップロード

#### 概要
ユーザーが処理対象のXMLファイルをシステムにアップロードできる機能

#### 詳細仕様

**入力**
- XMLファイル（拡張子: `.xml`）
- ファイルサイズ制限: 最大50MB（設定可能）

**動作**
1. ユーザーがファイル選択ダイアログを開く
2. XMLファイルを選択
3. ファイルが選択されたら、以下のチェックを実行:
   - ファイル拡張子が`.xml`であること
   - ファイルサイズが制限内であること
   - ファイルが読み取り可能であること
4. チェックに合格した場合、ファイルを一時保存領域に保存
5. ファイル情報（ファイル名、サイズ、アップロード日時）を表示

**出力**
- アップロード成功メッセージ
- ファイル情報の表示
- エラーがある場合はエラーメッセージ

**エラー処理**
- ファイル拡張子が`.xml`でない場合: 「XMLファイルを選択してください」というエラーメッセージを表示
- ファイルサイズが制限を超える場合: 「ファイルサイズが大きすぎます（最大50MB）」というエラーメッセージを表示
- ファイルが読み取り不可能な場合: 「ファイルを読み取れません」というエラーメッセージを表示

**ユーザビリティ要件**
- ドラッグ&ドロップでのアップロードに対応
- ファイル選択後、すぐにファイル情報が表示される
- アップロード中の状態が視覚的に分かる（ローディング表示など）

---

### FR-002: 変換スクリプトの選択

#### 概要
パイプライン処理で実行する変換スクリプトを選択する機能

#### 詳細仕様

**利用可能なスクリプト一覧**
1. `preprocess_non_first_sentence_to_list.py` - 前処理: Sentence要素をList要素に変換
2. `convert_article_focused.py` - Article要素の分割
3. `convert_paragraph_step3.py` - Paragraph処理（step3）
4. `convert_paragraph_step4.py` - Paragraph処理（step4）
5. `convert_item_step0.py` - Item変換
6. `convert_subitem1_step0.py` - Subitem1変換
7. `convert_subitem2_step0.py` - Subitem2変換
8. `convert_subitem3_step0.py` - Subitem3変換
9. `convert_subitem4_step0.py` - Subitem4変換
10. `convert_subitem5_step0.py` - Subitem5変換
11. `convert_subitem6_step0.py` - Subitem6変換
12. `convert_subitem7_step0.py` - Subitem7変換
13. `convert_subitem8_step0.py` - Subitem8変換
14. `convert_subitem9_step0.py` - Subitem9変換
15. `convert_subitem10_step0.py` - Subitem10変換

**動作**
1. 利用可能なスクリプトの一覧を表示
2. 各スクリプトについて、以下の情報を表示:
   - スクリプト名
   - スクリプトの説明（処理内容の概要）
   - 実行順序（推奨順序）
3. ユーザーが実行したいスクリプトを選択（複数選択可能）
4. 選択したスクリプトの実行順序を表示（選択順または推奨順序）
5. 選択したスクリプトの順序を変更可能（オプション）

**デフォルト動作**
- 初期状態では、すべてのスクリプトが選択されている
- スクリプトは推奨順序で並んでいる

**出力**
- 選択されたスクリプトの一覧
- 実行順序の表示

**エラー処理**
- スクリプトが1つも選択されていない場合: 「少なくとも1つのスクリプトを選択してください」というエラーメッセージを表示

**ユーザビリティ要件**
- スクリプトの説明が分かりやすい
- 選択状態が視覚的に分かる
- 「すべて選択」「すべて解除」のボタンがあると便利

---

### FR-003: パイプライン処理の実行

#### 概要
選択した変換スクリプトを順次実行する機能

#### 詳細仕様

**前提条件**
- XMLファイルがアップロードされていること
- 少なくとも1つのスクリプトが選択されていること

**動作**
1. ユーザーが「処理開始」ボタンをクリック
2. 処理開始前に、以下の確認を行う:
   - XMLファイルがアップロードされているか
   - スクリプトが選択されているか
   - 前回の処理結果が残っている場合、警告を表示（オプション）
3. 確認が完了したら、処理を開始
4. 選択したスクリプトを順次実行:
   - 各スクリプトの実行前に、入力ファイルの存在確認
   - スクリプトを実行
   - 出力ファイルの生成確認
   - エラーが発生した場合、処理を中断
5. 各スクリプトの実行結果を記録
6. すべてのスクリプトの実行が完了したら、最終出力ファイルを生成

**実行順序**
- ユーザーが指定した順序、または推奨順序で実行
- 推奨順序は、スクリプト名に基づいて自動的に決定される

**処理中の動作**
- 処理中は、他の操作を受け付けない（または制限する）
- 処理をキャンセルできる（オプション）

**出力**
- 各スクリプトの実行結果（成功/失敗）
- 最終出力ファイル
- エラーログ（エラーが発生した場合）

**エラー処理**
- スクリプトが見つからない場合: 「スクリプトが見つかりません: [スクリプト名]」というエラーメッセージを表示し、処理を中断
- スクリプトの実行に失敗した場合: 「[スクリプト名]の実行に失敗しました」というエラーメッセージを表示し、エラー詳細を表示、処理を中断
- タイムアウトが発生した場合: 「[スクリプト名]の実行がタイムアウトしました（5分）」というエラーメッセージを表示し、処理を中断
- 出力ファイルが生成されなかった場合: 「出力ファイルが生成されませんでした: [スクリプト名]」というエラーメッセージを表示し、処理を中断

**パフォーマンス要件**
- 1つのスクリプトの実行タイムアウト: 5分（設定可能）
- 処理中の状態がユーザーに分かるようにする

---

### FR-004: 処理済みXMLファイルのダウンロード

#### 概要
パイプライン処理が完了した後の最終出力XMLファイルをダウンロードする機能

#### 詳細仕様

**前提条件**
- パイプライン処理が正常に完了していること
- 最終出力ファイルが存在すること

**動作**
1. 処理が完了したら、「ダウンロード」ボタンを表示
2. ユーザーがダウンロードボタンをクリック
3. 最終出力ファイルをダウンロード可能な形式で提供
4. ファイル名は、元のファイル名に`-final`を付加したもの（例: `input.xml` → `input-final.xml`）

**出力**
- ダウンロード可能なXMLファイル
- ファイル名の提案

**エラー処理**
- 最終出力ファイルが存在しない場合: 「処理が完了していません」というメッセージを表示
- ダウンロードに失敗した場合: 「ダウンロードに失敗しました」というエラーメッセージを表示

**ユーザビリティ要件**
- ダウンロードボタンが目立つ位置にある
- ダウンロード開始時に通知を表示（オプション）

---

### FR-005: 処理進捗の表示

#### 概要
パイプライン処理の進捗状況をリアルタイムで表示する機能

#### 詳細仕様

**表示内容**
1. **全体進捗**
   - 現在実行中のスクリプト番号 / 全スクリプト数（例: 3/15）
   - 進捗バー（0%〜100%）
   - 経過時間（オプション）
   - 推定残り時間（オプション）

2. **現在のステップ情報**
   - 実行中のスクリプト名
   - スクリプトの説明
   - ステータス（実行中、完了、エラー）

3. **完了したステップの一覧**
   - スクリプト名
   - 実行結果（成功/失敗）
   - 実行時間（オプション）

**更新頻度**
- 進捗情報は、各スクリプトの実行開始時・完了時に更新される
- リアルタイムでの更新（ポーリングまたはWebSocket）

**表示形式**
- 進捗バー: 視覚的に分かりやすい形式（0%〜100%）
- ステップ一覧: リスト形式で表示
- 現在のステップ: 強調表示

**ユーザビリティ要件**
- 進捗状況が一目で分かる
- 処理が停止しているように見えない（ローディングアニメーションなど）

---

### FR-006: エラーメッセージの表示

#### 概要
処理中に発生したエラーを分かりやすく表示する機能

#### 詳細仕様

**エラーの種類**
1. **ファイル関連エラー**
   - ファイルが見つからない
   - ファイルが読み取り不可能
   - ファイルサイズが大きすぎる

2. **スクリプト実行エラー**
   - スクリプトが見つからない
   - スクリプトの実行に失敗
   - タイムアウト

3. **検証エラー**
   - 構文検証エラー
   - テキスト内容検証エラー

4. **システムエラー**
   - メモリ不足
   - ディスク容量不足

**表示内容**
- エラーの種類（カテゴリ）
- エラーメッセージ（ユーザーに分かりやすい表現）
- エラーの詳細（技術的な詳細、デバッグ用）
- 推奨される対処方法（可能な場合）

**表示形式**
- エラーは目立つ色で表示（例: 赤色）
- エラーメッセージは明確で分かりやすい
- 詳細情報は折りたたみ可能（オプション）

**ユーザビリティ要件**
- エラーメッセージが技術的すぎない
- 対処方法が提示される
- エラーが発生した箇所が特定できる

---

### FR-007: 構文検証の実行

#### 概要
XMLファイルが正しい形式（well-formed）かどうかをチェックする機能

#### 詳細仕様

**実行タイミング**
- XMLファイルがアップロードされた直後（処理開始前）
- オプション: 各スクリプト実行後の中間ファイルに対しても実行可能

**検証内容**
- XMLファイルが正しい形式（well-formed）であること
- XMLパーサーでパース可能であること

**動作**
1. アップロードされたXMLファイルに対して構文検証を実行
2. 検証結果を記録
3. 検証に失敗した場合:
   - エラーメッセージを表示
   - 処理の実行を許可しない（または警告を表示）
4. 検証に成功した場合:
   - 成功メッセージを表示
   - 処理の実行を許可

**出力**
- 検証結果（成功/失敗）
- エラーの詳細（失敗した場合）
- エラーが発生した行番号と内容（可能な場合）

**エラー処理**
- 検証に失敗した場合: 「XMLファイルの構文エラーが検出されました」というメッセージを表示し、エラー詳細を表示
- 検証スクリプトの実行に失敗した場合: 「検証処理に失敗しました」というメッセージを表示

**ユーザビリティ要件**
- 検証結果が明確に表示される
- エラーの場所が特定できる（行番号など）

---

### FR-008: テキスト内容検証の実行

#### 概要
元のXMLファイルと処理後のXMLファイルのテキスト内容が一致しているかを確認する機能

#### 詳細仕様

**実行タイミング**
- パイプライン処理が完了した後

**検証内容**
- 元のXMLファイルに含まれるすべてのテキストが、処理後のXMLファイルにも含まれていること
- 構造の変更は無視し、テキスト内容のみを比較

**動作**
1. パイプライン処理が完了したら、自動的にテキスト内容検証を実行
2. 元のXMLファイルと最終出力XMLファイルを比較
3. 検証結果を記録
4. 検証結果を表示

**出力**
- 検証結果（成功/失敗）
- 欠落したテキストの一覧（失敗した場合）
- 検証レポートファイル（テキスト形式）

**エラー処理**
- 検証スクリプトの実行に失敗した場合: 「検証処理に失敗しました」というメッセージを表示
- ファイルが見つからない場合: 「検証対象ファイルが見つかりません」というメッセージを表示

**ユーザビリティ要件**
- 検証結果が明確に表示される
- 欠落したテキストが分かりやすく表示される

---

### FR-009: 検証レポートの表示

#### 概要
構文検証とテキスト内容検証の結果を表示する機能

#### 詳細仕様

**表示内容**
1. **構文検証レポート**
   - 検証日時
   - 検証対象ファイル名
   - 検証結果（成功/失敗）
   - エラー詳細（失敗した場合）

2. **テキスト内容検証レポート**
   - 検証日時
   - 元ファイル名
   - 処理後ファイル名
   - 検証結果（成功/失敗）
   - 欠落したテキストの一覧（失敗した場合）

**表示形式**
- レポートはテキスト形式で表示
- 検証結果は視覚的に分かりやすく表示（成功: 緑色、失敗: 赤色）
- レポートはダウンロード可能（オプション）

**動作**
1. 検証が完了したら、検証レポートを自動的に表示
2. ユーザーがレポートを確認できる
3. レポートをダウンロードできる（オプション）

**ユーザビリティ要件**
- レポートが読みやすい形式で表示される
- 重要な情報が強調表示される

---

### FR-010: XMLファイルのプレビュー

#### 概要
アップロードしたXMLファイルや処理後のXMLファイルの内容をプレビューする機能

#### 詳細仕様

**プレビュー対象**
- アップロードしたXMLファイル
- 処理後の最終出力XMLファイル
- 中間ファイル（オプション）

**表示内容**
- XMLファイルの内容（テキスト形式）
- シンタックスハイライト（XML形式）
- 行番号（オプション）

**動作**
1. ユーザーが「プレビュー」ボタンをクリック
2. 選択したファイルの内容を表示
3. ファイルが大きい場合、最初の部分のみを表示し、続きを読み込むボタンを表示（オプション）

**表示形式**
- XMLの構造が分かりやすく表示される
- シンタックスハイライトで見やすくする
- 折りたたみ可能な形式（オプション）

**ユーザビリティ要件**
- プレビューが読みやすい
- 大きなファイルでも快適に表示できる

---

### FR-011: 中間ファイルのダウンロード

#### 概要
パイプライン処理の各ステップで生成された中間XMLファイルをダウンロードする機能

#### 詳細仕様

**対象ファイル**
- 各スクリプトの実行後に生成された中間XMLファイル
- ファイル名は、元のファイル名にステップ名を付加したもの（例: `input-convert_item_step0.xml`）

**動作**
1. 処理が完了したら、中間ファイルの一覧を表示
2. ユーザーがダウンロードしたい中間ファイルを選択
3. 選択したファイルをダウンロード可能な形式で提供

**表示内容**
- 中間ファイルの一覧
- 各ファイルの説明（どのステップで生成されたか）
- ファイルサイズ（オプション）

**ユーザビリティ要件**
- 中間ファイルの一覧が分かりやすい
- どのステップで生成されたかが明確

---

### FR-012: 処理履歴の保存

#### 概要
過去に実行した処理の記録を保存する機能

#### 詳細仕様

**保存する情報**
- 処理日時
- アップロードしたファイル名
- 選択したスクリプトの一覧
- 処理結果（成功/失敗）
- 最終出力ファイル名
- 検証結果（構文検証、テキスト内容検証）
- エラーメッセージ（エラーが発生した場合）

**保存形式**
- データベースまたはファイル形式
- 検索・フィルタリングが可能な形式

**動作**
1. 処理が完了したら、処理履歴を自動的に保存
2. 保存された履歴は、後から参照可能

**保存期間**
- 履歴は一定期間保存される（設定可能、デフォルト: 30日）

**ユーザビリティ要件**
- 履歴の保存が自動的に行われる
- ユーザーが履歴を削除できる（オプション）

---

### FR-013: 処理履歴の表示

#### 概要
過去に実行した処理の履歴を表示する機能

#### 詳細仕様

**表示内容**
- 処理日時
- ファイル名
- 選択したスクリプトの数
- 処理結果（成功/失敗）
- 検証結果（成功/失敗/未実行）

**表示形式**
- リスト形式で表示
- 日時順に並べ替え可能（新しい順/古い順）
- フィルタリング可能（成功のみ、失敗のみなど）
- 検索可能（ファイル名で検索）

**動作**
1. ユーザーが「履歴」画面に移動
2. 保存されている処理履歴の一覧を表示
3. 各履歴の詳細を表示できる（オプション）
4. 過去の処理結果を再ダウンロードできる（オプション）

**ユーザビリティ要件**
- 履歴が分かりやすく表示される
- 必要な情報がすぐに見つかる

---

### FR-014: 設定の保存

#### 概要
よく使用する設定（スクリプトの選択など）を保存する機能

#### 詳細仕様

**保存する設定**
- よく使用するスクリプトの組み合わせ
- ファイルサイズ制限などの設定（オプション）

**動作**
1. ユーザーが設定を保存したい場合、「設定を保存」ボタンをクリック
2. 設定に名前を付ける
3. 設定を保存
4. 保存した設定を後から読み込める

**設定の読み込み**
- 保存した設定の一覧を表示
- ユーザーが設定を選択して読み込む
- 読み込んだ設定が画面に反映される

**ユーザビリティ要件**
- 設定の保存・読み込みが簡単
- 設定に分かりやすい名前を付けられる

---

### FR-015: 複数ファイルの一括アップロード

#### 概要
複数のXMLファイルを一度にアップロードする機能

#### 詳細仕様

**動作**
1. ユーザーが複数のXMLファイルを選択（またはフォルダを選択）
2. 選択したファイルを一括でアップロード
3. アップロードしたファイルの一覧を表示

**制限**
- 一度にアップロードできるファイル数: 最大10個（設定可能）
- 合計ファイルサイズの制限: 最大500MB（設定可能）

**エラー処理**
- 一部のファイルのアップロードに失敗した場合、成功したファイルはアップロードし、失敗したファイルについてエラーメッセージを表示

**ユーザビリティ要件**
- 複数ファイルの選択が簡単
- アップロード状況が分かる

---

### FR-016: バッチ処理の実行

#### 概要
複数のXMLファイルに対して、同じ設定でパイプライン処理を一括実行する機能

#### 詳細仕様

**前提条件**
- 複数のXMLファイルがアップロードされていること
- 処理設定（スクリプトの選択）が完了していること

**動作**
1. ユーザーが「バッチ処理を開始」ボタンをクリック
2. アップロードされたすべてのXMLファイルに対して、同じ設定でパイプライン処理を実行
3. 各ファイルの処理結果を記録
4. すべての処理が完了したら、結果のサマリーを表示

**処理方法**
- ファイルを順次処理（1つずつ処理）
- または並列処理（複数ファイルを同時に処理、オプション）

**出力**
- 各ファイルの処理結果
- 処理済みXMLファイルの一括ダウンロード（ZIP形式など）

**エラー処理**
- 一部のファイルの処理に失敗した場合、成功したファイルは処理し、失敗したファイルについてエラーメッセージを表示

**ユーザビリティ要件**
- バッチ処理の進捗が分かる
- 処理結果が分かりやすく表示される

---

### FR-017: バッチ処理の進捗表示

#### 概要
バッチ処理の進捗状況を表示する機能

#### 詳細仕様

**表示内容**
- 処理中のファイル番号 / 全ファイル数（例: 3/10）
- 全体の進捗バー（0%〜100%）
- 現在処理中のファイル名
- 各ファイルの処理結果（成功/失敗）

**更新頻度**
- 各ファイルの処理開始時・完了時に更新

**表示形式**
- 全体の進捗バー
- ファイルごとの処理状況の一覧

**ユーザビリティ要件**
- 進捗状況が一目で分かる
- どのファイルが処理中かが明確

---

### FR-018: 処理結果の比較

#### 概要
複数の処理結果を比較する機能

#### 詳細仕様

**比較対象**
- 異なる設定で処理した結果
- 異なるバージョンのスクリプトで処理した結果

**比較内容**
- XMLファイルの構造の違い
- テキスト内容の違い
- 検証結果の違い

**表示形式**
- 差分表示（追加・削除・変更された部分を強調）
- 比較レポート（テキスト形式）

**ユーザビリティ要件**
- 差分が分かりやすく表示される
- 比較結果をダウンロードできる

---

### FR-019: 設定プロファイルの保存

#### 概要
用途別の設定プロファイルを保存・管理する機能

#### 詳細仕様

**プロファイルの内容**
- プロファイル名
- 選択するスクリプトの組み合わせ
- その他の設定（オプション）

**動作**
1. ユーザーが設定プロファイルを作成
2. プロファイルに名前を付ける（例: 「標準処理」「簡易処理」）
3. プロファイルを保存
4. 後からプロファイルを選択して読み込む

**プロファイルの管理**
- プロファイルの一覧表示
- プロファイルの編集
- プロファイルの削除

**ユーザビリティ要件**
- プロファイルの作成・管理が簡単
- プロファイルに分かりやすい名前を付けられる

---

### FR-020: ユーザー認証

#### 概要
複数ユーザーが利用する場合の認証機能

#### 詳細仕様

**認証方法**
- ユーザー名とパスワード
- または既存の認証システムとの連携（オプション）

**認証後の動作**
- ユーザーごとの処理履歴の管理
- ユーザーごとの設定の保存

**権限管理**
- 管理者権限（すべての機能にアクセス可能）
- 一般ユーザー権限（基本的な機能のみ）

**ユーザビリティ要件**
- 認証が簡単
- セッション管理が適切

---

### FR-021: 処理キュー管理

#### 概要
長時間処理を非同期で実行し、キューで管理する機能

#### 詳細仕様

**動作**
1. ユーザーが処理を開始
2. 処理をキューに追加
3. バックグラウンドで処理を実行
4. 処理が完了したら、ユーザーに通知

**キューの管理**
- キューの一覧表示
- キューの状態（待機中、実行中、完了、エラー）
- キューのキャンセル（オプション）

**ユーザビリティ要件**
- キューの状態が分かる
- 処理が完了したら通知される

---

### FR-022: 通知機能

#### 概要
処理が完了したときにユーザーに通知する機能

#### 詳細仕様

**通知方法**
- ブラウザ内の通知
- メール通知（オプション）

**通知内容**
- 処理が完了したこと
- 処理結果（成功/失敗）
- ダウンロードリンク（オプション）

**通知設定**
- 通知を受け取るかどうかの設定
- 通知方法の選択

**ユーザビリティ要件**
- 通知が適切なタイミングで届く
- 通知内容が分かりやすい

---

### FR-023: ラベル設定の表示

#### 概要
ラベル設定ファイル（`label_config.json`）の内容を表示する機能

#### 詳細仕様

**表示する設定内容**
1. **ラベル定義（label_definitions）**
   - 各ラベルパターンの定義
   - ラベルID、名前、パターン（正規表現）、例、説明

2. **パターン優先度（pattern_priority）**
   - ラベルパターンの優先順位リスト
   - 優先度の高い順に表示

3. **階層ルール（hierarchy_rules）**
   - 階層処理のルール設定
   - 同じパターンは同じ階層にまとめるかどうか
   - 特殊パターン（学年パターン、科目パターン）の設定

4. **変換動作（conversion_behaviors）**
   - 変換時の動作設定
   - Column処理の動作設定
   - カラムなしリストの分割モード設定

**表示形式**
- 設定項目ごとにセクション分けして表示
- ラベル定義は表形式で表示（ID、名前、パターン、例、説明）
- パターン優先度はリスト形式で表示
- 階層ルールと変換動作は設定項目ごとに表示

**動作**
1. ユーザーが「ラベル設定」画面にアクセス
2. 現在の設定ファイル（`label_config.json`）の内容を読み込む
3. 設定内容を分かりやすい形式で表示
4. 設定の説明やヘルプを表示（オプション）

**ユーザビリティ要件**
- 設定内容が分かりやすく表示される
- 各設定項目の説明が表示される
- 設定の検索ができる（オプション）

---

### FR-024: ラベル設定の編集

#### 概要
ラベル設定ファイルの内容を編集する機能

#### 詳細仕様

**編集可能な設定項目**

1. **ラベル定義の編集**
   - 新しいラベル定義の追加
   - 既存のラベル定義の編集（ID、名前、パターン、例、説明）
   - ラベル定義の削除
   - ラベル定義の並び替え（オプション）

2. **パターン優先度の編集**
   - 優先度の順序変更（ドラッグ&ドロップまたは上下ボタン）
   - 優先度リストへの追加・削除

3. **階層ルールの編集**
   - 同じパターンは同じ階層にまとめるかの設定（true/false）
   - 階層をまたぐ分割を許可するかの設定（true/false）
   - 特殊パターン（学年パターン、科目パターン）の設定

4. **変換動作の編集**
   - Column処理の動作設定（有効/無効）
   - 対象レベル（Item、Subitem1〜10）の選択
   - カラムなしリストの分割モード設定（有効/無効）

**編集インターフェース**
- フォーム形式で編集可能
- ラベル定義の追加・編集は、各項目を入力するフォーム
- パターン優先度は、リスト形式で並び替え可能
- 階層ルールと変換動作は、チェックボックスやセレクトボックスで設定

**動作**
1. ユーザーが「ラベル設定の編集」画面にアクセス
2. 現在の設定を読み込んで表示
3. ユーザーが設定を編集
4. 編集内容をプレビュー（オプション）
5. 「保存」ボタンをクリックして設定を保存

**バリデーション**
- 編集内容の妥当性チェック（FR-027参照）
- エラーがある場合、保存前にエラーメッセージを表示

**ユーザビリティ要件**
- 編集が直感的にできる
- 設定項目の説明が表示される
- 変更前の設定と変更後の設定を比較できる（オプション）
- 元の設定に戻す機能（リセット機能）

---

### FR-025: ラベル設定の保存

#### 概要
編集したラベル設定を保存する機能

#### 詳細仕様

**保存内容**
- 編集したすべての設定項目
- 設定ファイル（`label_config.json`）として保存

**保存形式**
- JSON形式で保存
- 既存の`label_config.json`ファイルを上書き、または新しいファイルとして保存

**動作**
1. ユーザーが「保存」ボタンをクリック
2. 設定内容のバリデーションを実行（FR-027参照）
3. バリデーションに合格した場合、設定を保存
4. 保存成功メッセージを表示
5. バリデーションに不合格の場合、エラーメッセージを表示して保存を中止

**保存オプション**
- 既存の設定ファイルを上書き
- 新しい設定ファイルとして保存（ファイル名を指定）
- 設定のバックアップを自動的に作成（オプション）

**エラー処理**
- ファイルの保存に失敗した場合: 「設定の保存に失敗しました」というエラーメッセージを表示
- 権限がない場合: 「設定ファイルへの書き込み権限がありません」というエラーメッセージを表示

**ユーザビリティ要件**
- 保存前に確認ダイアログを表示（オプション）
- 保存成功時に通知を表示
- 保存した設定がすぐに反映される

---

### FR-026: ラベル設定のインポート/エクスポート

#### 概要
ラベル設定ファイルをインポート/エクスポートする機能

#### 詳細仕様

**エクスポート機能**

**動作**
1. ユーザーが「設定をエクスポート」ボタンをクリック
2. 現在の設定をJSON形式でエクスポート
3. ファイル名を指定してダウンロード（デフォルト: `label_config_YYYYMMDD.json`）

**エクスポート形式**
- JSON形式
- 設定ファイルの完全なコピー

**インポート機能**

**動作**
1. ユーザーが「設定をインポート」ボタンをクリック
2. JSON形式の設定ファイルを選択
3. 設定ファイルのバリデーションを実行（FR-027参照）
4. バリデーションに合格した場合、設定を読み込んで表示
5. ユーザーが確認して「適用」ボタンをクリック
6. 設定を保存

**インポート形式**
- JSON形式の設定ファイル
- 既存の設定ファイル形式と互換性があること

**エラー処理**
- ファイル形式が正しくない場合: 「設定ファイルの形式が正しくありません」というエラーメッセージを表示
- 必須項目が欠けている場合: 「必須項目が欠けています: [項目名]」というエラーメッセージを表示
- バリデーションエラーがある場合: エラー詳細を表示

**ユーザビリティ要件**
- インポート前に現在の設定のバックアップを自動的に作成（オプション）
- インポート前に確認ダイアログを表示
- インポートした設定をプレビューできる

---

### FR-027: ラベル設定のバリデーション

#### 概要
ラベル設定の妥当性をチェックする機能

#### 詳細仕様

**バリデーション項目**

1. **JSON形式のチェック**
   - JSONファイルが正しい形式であること
   - JSONの構文エラーがないこと

2. **必須項目のチェック**
   - `label_definitions`が存在すること
   - `pattern_priority`が存在すること
   - `hierarchy_rules`が存在すること（オプション）
   - `conversion_behaviors`が存在すること（オプション）

3. **ラベル定義のチェック**
   - 各ラベル定義に必須項目（id、name、patterns）が含まれていること
   - ラベルIDが重複していないこと
   - パターン（正規表現）が正しい形式であること
   - パターン優先度に含まれるラベルIDが、ラベル定義に存在すること

4. **パターン優先度のチェック**
   - 優先度リストに含まれるラベルIDが、ラベル定義に存在すること
   - 優先度リストに重複がないこと（オプション）

5. **階層ルールのチェック**
   - 特殊パターンのリストに含まれるラベルIDが、ラベル定義に存在すること

6. **変換動作のチェック**
   - 対象レベルが有効な値であること（Item、Subitem1〜10）

**動作**
1. 設定の保存時またはインポート時に自動的にバリデーションを実行
2. バリデーション結果を表示
3. エラーがある場合、エラーの詳細を表示

**表示形式**
- バリデーション結果をリスト形式で表示
- エラーがある場合、エラーの種類と詳細を表示
- エラーが発生した項目へのリンクを表示（オプション）

**エラーメッセージ**
- エラーの種類ごとに分かりやすいメッセージを表示
- エラーの修正方法を提示（可能な場合）

**ユーザビリティ要件**
- バリデーション結果が分かりやすく表示される
- エラーの修正がしやすい

---

### FR-028: ラベル設定のプレビュー/テスト

#### 概要
ラベル設定を実際のXMLファイルでテストする機能

#### 詳細仕様

**テスト機能**

**動作**
1. ユーザーが編集したラベル設定を選択
2. テスト用のXMLファイルをアップロード（または既存のXMLファイルを使用）
3. 「テスト実行」ボタンをクリック
4. 選択したラベル設定を使用して、テスト用のXMLファイルを処理
5. 処理結果を表示

**表示内容**
- 処理前後のXMLファイルの比較
- どのラベルパターンが適用されたかの表示
- 処理結果のサマリー

**プレビュー機能**

**動作**
1. ユーザーがラベル設定を編集
2. 「プレビュー」ボタンをクリック
3. 編集した設定がどのように適用されるかを表示
4. 設定の変更が処理結果にどのような影響を与えるかを確認

**表示内容**
- ラベル定義の一覧（編集後の状態）
- パターン優先度の一覧（編集後の状態）
- 設定の変更点のハイライト（オプション）

**テスト用データ**
- サンプルXMLファイルを提供（オプション）
- ユーザーが独自のテスト用XMLファイルをアップロード可能

**ユーザビリティ要件**
- テスト結果が分かりやすく表示される
- 設定の変更が処理結果に与える影響が確認できる
- テスト用データが簡単に選択できる

---

### FR-029: ブーリアン型パラメーターの簡易設定

#### 概要
JSONファイル全体を編集するのではなく、現在のJSONファイルをベースとして、ブーリアン型のパラメーターのみを簡単にオン/オフできる機能

#### 詳細仕様

**対象となるブーリアン型パラメーター**

1. **階層ルール（hierarchy_rules）**
   - `same_pattern_same_hierarchy`: 同じパターンは同じ階層にまとめるかどうか（true/false）
   - `allow_cross_hierarchy_split`: 階層をまたぐ分割を許可するかどうか（true/false）

2. **変換動作（conversion_behaviors）**
   - `column_list_text_first_column.enabled`: Column処理の動作設定を有効にするかどうか（true/false）
   - `no_column_text_split_mode.enabled`: カラムなしリストの分割モードを有効にするかどうか（true/false）

**動作**

1. **設定の読み込み**
   - 現在の`label_config.json`ファイルを読み込む
   - ブーリアン型パラメーターの現在の値を取得
   - 各パラメーターの説明と現在の設定値を表示

2. **設定の表示**
   - 各ブーリアン型パラメーターをチェックボックスまたはトグルスイッチで表示
   - 各パラメーターについて以下を表示:
     - パラメーター名
     - 説明（どのような動作をするか）
     - 現在の設定値（オン/オフ）
     - デフォルト値（JSONファイルから読み込んだ値）

3. **設定の変更**
   - ユーザーがチェックボックスまたはトグルスイッチを操作
   - 設定値が即座に反映される（プレビュー）
   - 変更されたパラメーターが視覚的に分かる（ハイライトなど）

4. **設定の保存**
   - ユーザーが「設定を保存」ボタンをクリック
   - 変更されたブーリアン型パラメーターのみをJSONファイルに反映
   - 他の設定項目（ラベル定義、パターン優先度など）は変更しない
   - 保存成功メッセージを表示

**表示形式**

**階層ルールセクション**
- 「同じパターンは同じ階層にまとめる」: チェックボックス（デフォルト: true）
- 「階層をまたぐ分割を許可する」: チェックボックス（デフォルト: false）

**変換動作セクション**
- 「Column処理の動作設定を有効にする」: チェックボックス（デフォルト: true）
  - 説明: 「Columnが2つあり、かつ1つ目のColumnがラベル要素に該当しない場合、ItemSentence/Subitem*Sentenceの中にSentence要素を2つ作成して各Columnの値を挿入する」
- 「カラムなしリストの分割モードを有効にする」: チェックボックス（デフォルト: true）
  - 説明: 「no_column_textタイプのItemの後、カラムなしリストを並列分割するかどうか。false: List要素のまま取り込む（モード1）、true: 並列分割して別々のItem要素に変換（モード2）」

**動作フロー**

1. ユーザーが「簡易設定」画面にアクセス
2. 現在の`label_config.json`ファイルを読み込む
3. ブーリアン型パラメーターの現在の値を表示
4. ユーザーが設定を変更（チェックボックスをオン/オフ）
5. 変更内容をプレビュー（オプション）
6. 「設定を保存」ボタンをクリック
7. 変更されたパラメーターのみをJSONファイルに反映
8. 保存成功メッセージを表示

**JSONファイルへの反映方法**

- 変更されたブーリアン型パラメーターのみを更新
- 他の設定項目（`label_definitions`、`pattern_priority`など）は変更しない
- JSONファイルの構造とフォーマットを維持

**例: 設定変更のイメージ**

```
現在の設定:
- 同じパターンは同じ階層にまとめる: ✓ (true)
- 階層をまたぐ分割を許可する: ☐ (false)
- Column処理の動作設定を有効にする: ✓ (true)
- カラムなしリストの分割モードを有効にする: ✓ (true)

ユーザーが変更:
- 階層をまたぐ分割を許可する: ☐ → ✓ (false → true)

保存後のJSON:
{
  "hierarchy_rules": {
    "same_pattern_same_hierarchy": true,  // 変更なし
    "allow_cross_hierarchy_split": true,  // 変更あり
    ...
  },
  "conversion_behaviors": {
    "column_list_text_first_column": {
      "enabled": true,  // 変更なし
      ...
    },
    ...
  }
}
```

**エラー処理**

- JSONファイルが読み込めない場合: 「設定ファイルを読み込めません」というエラーメッセージを表示
- 必須のブーリアン型パラメーターが存在しない場合: 「設定ファイルに必須項目がありません」というエラーメッセージを表示
- 設定の保存に失敗した場合: 「設定の保存に失敗しました」というエラーメッセージを表示

**ユーザビリティ要件**

- 各パラメーターの説明が分かりやすい
- 現在の設定値が明確に表示される
- 変更されたパラメーターが視覚的に分かる
- 設定の変更が簡単（チェックボックスまたはトグルスイッチ）
- 保存前に変更内容を確認できる
- デフォルト値に戻す機能（リセット機能）

**FR-024（ラベル設定の編集）との違い**

- **FR-024**: JSONファイル全体を編集可能（ラベル定義の追加・編集、パターン優先度の変更など）
- **FR-029**: ブーリアン型パラメーターのみを簡単にオン/オフできる（JSONファイル全体の編集は不要）

**使用シーン**

- よく使う設定の切り替え（例: カラムなしリストの分割モードのオン/オフ）
- 動作の微調整（例: 階層ルールの変更）
- JSONファイル全体を編集する必要がない場合の簡易設定

---

## ユーザーストーリー

## ユーザーストーリー

### ストーリー1: 基本的なXMLファイルの処理

**ユーザー**: 教育課程関連のXMLファイルを処理する必要がある業務担当者

**目的**: XMLファイルを階層構造に整形する

**シナリオ**:
1. ユーザーがWebアプリケーションにアクセス
2. XMLファイルをアップロード
3. デフォルトの設定（すべてのスクリプトが選択されている）で処理を開始
4. 処理の進捗を確認
5. 処理が完了したら、処理済みXMLファイルをダウンロード
6. 検証レポートを確認して、処理が正常に完了したことを確認

**期待される結果**: XMLファイルが正常に処理され、ダウンロードできる

---

### ストーリー2: カスタム設定での処理

**ユーザー**: 特定のスクリプトのみを実行したいユーザー

**目的**: 必要なスクリプトのみを選択して処理を実行する

**シナリオ**:
1. ユーザーがXMLファイルをアップロード
2. スクリプトの一覧から、実行したいスクリプトのみを選択
3. 処理を開始
4. 処理が完了したら、結果を確認

**期待される結果**: 選択したスクリプトのみが実行され、処理が完了する

---

### ストーリー3: エラー発生時の対応

**ユーザー**: 処理中にエラーが発生したユーザー

**目的**: エラーの原因を特定し、対処する

**シナリオ**:
1. ユーザーがXMLファイルをアップロード
2. 処理を開始
3. 処理中にエラーが発生
4. エラーメッセージを確認
5. エラーの原因を特定（例: XMLファイルの構文エラー）
6. XMLファイルを修正して、再度処理を実行

**期待される結果**: エラーの原因が分かり、適切に対処できる

---

### ストーリー4: 複数ファイルの一括処理

**ユーザー**: 複数のXMLファイルを処理する必要があるユーザー

**目的**: 複数のXMLファイルを効率的に処理する

**シナリオ**:
1. ユーザーが複数のXMLファイルを一括アップロード
2. 処理設定を選択
3. バッチ処理を開始
4. バッチ処理の進捗を確認
5. すべての処理が完了したら、処理済みXMLファイルを一括ダウンロード

**期待される結果**: 複数のXMLファイルが正常に処理され、一括ダウンロードできる

---

### ストーリー5: 処理履歴の確認

**ユーザー**: 過去に処理したファイルを確認したいユーザー

**目的**: 過去の処理履歴を確認し、必要に応じて再ダウンロードする

**シナリオ**:
1. ユーザーが「履歴」画面にアクセス
2. 過去の処理履歴の一覧を確認
3. 特定の処理の詳細を確認
4. 必要に応じて、処理済みXMLファイルを再ダウンロード

**期待される結果**: 過去の処理履歴が確認でき、必要に応じて再ダウンロードできる

---

### ストーリー6: ラベル設定の編集

**ユーザー**: 新しいラベルパターンを追加したいユーザー

**目的**: ラベル設定を編集して、新しいラベルパターンを認識できるようにする

**シナリオ**:
1. ユーザーが「ラベル設定」画面にアクセス
2. 現在のラベル設定を確認
3. 「編集」ボタンをクリック
4. 新しいラベル定義を追加（ID、名前、パターン、例、説明を入力）
5. パターン優先度に新しいラベルを追加
6. 設定のバリデーションを実行
7. バリデーションに合格したら、設定を保存
8. テスト用のXMLファイルで設定をテスト
9. テスト結果を確認して、設定が正しく動作することを確認

**期待される結果**: 新しいラベルパターンが追加され、XMLファイルの処理時に正しく認識される

---

### ストーリー7: ラベル設定のインポート

**ユーザー**: 他の環境で作成したラベル設定を使用したいユーザー

**目的**: 既存のラベル設定ファイルをインポートして使用する

**シナリオ**:
1. ユーザーが「ラベル設定」画面にアクセス
2. 「設定をインポート」ボタンをクリック
3. JSON形式の設定ファイルを選択
4. 設定ファイルのバリデーションを実行
5. バリデーションに合格したら、設定をプレビュー
6. 設定を確認して「適用」ボタンをクリック
7. 現在の設定のバックアップを自動的に作成（オプション）
8. 設定を保存
9. インポートした設定でXMLファイルを処理してテスト

**期待される結果**: 設定ファイルが正常にインポートされ、使用できる

---

### ストーリー8: ブーリアン型パラメーターの簡易設定

**ユーザー**: 変換動作を簡単に切り替えたいユーザー

**目的**: JSONファイル全体を編集せずに、ブーリアン型パラメーターだけを簡単にオン/オフする

**シナリオ**:
1. ユーザーが「簡易設定」画面にアクセス
2. 現在の設定が表示される（各ブーリアン型パラメーターの現在の値）
3. 「カラムなしリストの分割モードを有効にする」のチェックを外す（falseに変更）
4. 変更内容を確認
5. 「設定を保存」ボタンをクリック
6. 設定が保存され、次回の処理から新しい設定が適用される
7. テスト用のXMLファイルで処理を実行して、設定が正しく反映されていることを確認

**期待される結果**: ブーリアン型パラメーターが簡単に変更でき、設定が正しく反映される

---

## 非機能要件

### パフォーマンス要件

| 項目 | 要件 |
|------|------|
| **応答時間** | ファイルアップロード後、3秒以内に処理開始可能 |
| **処理時間** | 1つのXMLファイル（10MB以下）の処理が5分以内に完了 |
| **同時処理** | 初期は1ユーザーのみ、将来的に複数ユーザー対応 |
| **ファイルサイズ** | 最大50MBのXMLファイルを処理可能 |
| **タイムアウト** | 1つのスクリプトの実行タイムアウト: 5分 |

### 可用性要件

| 項目 | 要件 |
|------|------|
| **稼働時間** | 業務時間中（平日9:00〜18:00）は利用可能 |
| **ダウンタイム** | メンテナンス時以外はダウンタイムなし |

### セキュリティ要件

| 項目 | 要件 |
|------|------|
| **ファイルの保護** | アップロードされたファイルは適切に保護される |
| **データの削除** | 処理が完了したら、一時ファイルは適切に削除される |
| **アクセス制御** | 初期は認証不要、将来的に認証機能を追加可能 |

### ユーザビリティ要件

| 項目 | 要件 |
|------|------|
| **操作性** | 技術的な知識がなくても操作できる |
| **エラーメッセージ** | エラーメッセージが分かりやすい |
| **ヘルプ** | 使用方法が分かるヘルプや説明がある |
| **レスポンシブ** | モバイルデバイスでも利用可能（オプション） |

### 保守性要件

| 項目 | 要件 |
|------|------|
| **ログ** | 処理の実行ログが記録される |
| **エラーログ** | エラーが発生した場合、詳細なログが記録される |
| **設定** | 設定が外部ファイルなどで管理可能 |

---

## 制約事項

### 技術的制約

- 既存のPythonスクリプト（15個の変換スクリプト）をそのまま利用する必要がある
- 既存の検証スクリプト（`validate_xml.py`、`compare_xml_text_content.py`）をそのまま利用する必要がある
- XMLファイルの処理は、既存のスクリプトの仕様に従う

### 業務的制約

- 初期は内部ツールとして使用（認証は不要）
- 将来的に複数ユーザー対応が必要になる可能性がある
- 処理履歴の保存期間は30日程度を想定

### 環境的制約

- サーバー環境は未確定（クラウドまたはオンプレミス）
- ブラウザは最新版のChrome、Firefox、Safari、Edgeをサポート

---

## 付録

### 変換スクリプトの詳細

| スクリプト名 | 処理内容 | 実行順序 |
|------------|---------|---------|
| `preprocess_non_first_sentence_to_list.py` | 前処理: Sentence要素をList要素に変換 | 1 |
| `convert_article_focused.py` | Article要素の分割 | 2 |
| `convert_paragraph_step3.py` | Paragraph処理（step3） | 3 |
| `convert_paragraph_step4.py` | Paragraph処理（step4） | 4 |
| `convert_item_step0.py` | Item変換 | 5 |
| `convert_subitem1_step0.py` | Subitem1変換 | 6 |
| `convert_subitem2_step0.py` | Subitem2変換 | 7 |
| `convert_subitem3_step0.py` | Subitem3変換 | 8 |
| `convert_subitem4_step0.py` | Subitem4変換 | 9 |
| `convert_subitem5_step0.py` | Subitem5変換 | 10 |
| `convert_subitem6_step0.py` | Subitem6変換 | 11 |
| `convert_subitem7_step0.py` | Subitem7変換 | 12 |
| `convert_subitem8_step0.py` | Subitem8変換 | 13 |
| `convert_subitem9_step0.py` | Subitem9変換 | 14 |
| `convert_subitem10_step0.py` | Subitem10変換（最終） | 15 |

### 検証スクリプトの詳細

| スクリプト名 | 処理内容 | 実行タイミング |
|------------|---------|---------------|
| `validate_xml.py` | XML構文検証 | 処理開始前 |
| `compare_xml_text_content.py` | テキスト内容検証 | 処理完了後 |

### ラベル設定ファイル（label_config.json）の詳細

ラベル設定ファイルは、XMLファイル内のラベルパターンを認識するための設定を定義します。

#### 主要な設定項目

1. **ラベル定義（label_definitions）**
   - XMLファイル内で認識するラベルパターンの定義
   - 各ラベル定義には以下が含まれます:
     - `id`: ラベルID（一意の識別子）
     - `name`: ラベルの名前（表示用）
     - `patterns`: 正規表現パターンのリスト
     - `examples`: ラベルの例
     - `description`: ラベルの説明

2. **パターン優先度（pattern_priority）**
   - ラベルパターンの優先順位リスト
   - 複数のパターンにマッチする場合、優先度の高いパターンが適用される
   - リストの順序が優先度を表す（先頭が最も高い優先度）

3. **階層ルール（hierarchy_rules）**
   - XML要素の階層処理に関するルール設定
   - `same_pattern_same_hierarchy`: 同じパターンは同じ階層にまとめるかどうか
   - `allow_cross_hierarchy_split`: 階層をまたぐ分割を許可するかどうか
   - `special_patterns`: 特殊パターン（学年パターン、科目パターン）の設定

4. **変換動作（conversion_behaviors）**
   - XML変換時の動作設定
   - `column_list_text_first_column`: Columnが2つあり、1つ目がテキストの場合の処理方法
   - `no_column_text_split_mode`: カラムなしリストの分割モード設定

#### ラベル定義の種類

ラベル定義には以下のような種類があります:

- **数字系ラベル**: 括弧付き数字（`（１）`、`（一）`など）、丸数字（`①`など）
- **カタカナラベル**: 括弧付きカタカナ（`（ア）`、`（イ）`など）
- **アルファベットラベル**: 括弧付きアルファベット（`（a）`、`（A）`など）
- **学年ラベル**: 学年を示すラベル（`〔第１学年〕`など）
- **科目ラベル**: 科目名を示すラベル（`〔医療と社会〕`など）
- **その他の特殊ラベル**: ドット区切り数字、注記など

#### 設定ファイルの構造例

```json
{
  "version": "1.0",
  "label_definitions": {
    "paren_fullwidth_number": {
      "id": "paren_fullwidth_number",
      "name": "括弧全角数字",
      "patterns": ["^[（(][０-９]+[）)]$"],
      "examples": ["（１）", "（２）"],
      "description": "Item/Subitem1レベル"
    }
  },
  "pattern_priority": [
    "paren_fullwidth_number",
    "paren_katakana"
  ],
  "hierarchy_rules": {
    "same_pattern_same_hierarchy": true,
    "allow_cross_hierarchy_split": false
  },
  "conversion_behaviors": {
    "column_list_text_first_column": {
      "enabled": true,
      "target_levels": ["Item", "Subitem1"]
    }
  }
}
```

#### ラベル設定の管理

- **設定ファイルの場所**: `scripts/config/label_config.json`
- **設定の適用**: パイプライン処理実行時に自動的に読み込まれる
- **設定の変更**: Webアプリ内で編集・保存可能（FR-023〜FR-028参照）

---

**最終更新**: 2025年1月

