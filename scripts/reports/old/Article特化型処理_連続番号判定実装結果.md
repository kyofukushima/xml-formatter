# Article特化型処理：連続番号判定実装結果

## 実施日
2025年10月28日

## 概要
Article要素に特化した階層限定型変換スクリプトに**連続番号判定機能**を実装し、`test_input5.xml`に対して実行した結果を分析しました。

---

## 1. 実装内容

### 追加した機能

#### 1.1. 純粋な数字ラベル判定
```python
def is_pure_number_label(self, label: str) -> bool:
    """純粋な数字ラベルかを判定（括弧なし）"""
    # 括弧付き数字（（１）, (1)）を除外
    # 純粋な数字（１, 2）のみTrue
```

**目的:** 括弧付き数字（Item候補）を除外し、純粋な数字のみを判定

#### 1.2. 数字の正規化
```python
def normalize_number(self, label: str) -> int:
    """全角・半角数字を統一して整数に変換"""
    # "１" → 1, "２" → 2, "1" → 1, "2" → 2
```

**目的:** 全角・半角を統一して連続性を判定可能にする

#### 1.3. 連続番号判定
```python
def is_continuous_paragraph_num(self, current_label: str, previous_para_nums: List[str]) -> bool:
    """現在のラベルが前のParagraphNumと連続しているかを判定"""
    # １→２→３のように連続している場合のみTrue
    # １の後に３が来た場合はFalse（連続していない）
```

**目的:** 連続性を確認し、連続している場合のみParagraphに変換

#### 1.4. Paragraph判定の統合
```python
def is_paragraph_label(self, label: str, previous_para_nums: List[str]) -> bool:
    """Paragraph要素のラベルかを判定（数字かつ連続、または空）"""
    # 1. 空ラベル → True
    # 2. 純粋な数字でない → False（括弧付きなど）
    # 3. 連続している → True
    # 4. 連続していない → False（Item特化処理で処理）
```

**目的:** すべての判定条件を統合し、適切なList要素のみをParagraphに変換

### 変換ロジックの修正

1. **ParagraphNumリストの追跡**: Article内のすべてのParagraphNumを記録
2. **連続性チェック**: 各List要素のラベルが連続しているか確認
3. **適切な保持**: 連続していないList要素はItem特化処理用に保持
4. **統計記録**: 保持したList要素数を記録（`lists_skipped`）

---

## 2. 変換結果の比較

### 要素数の変化

| 要素名 | 入力 | 期待値 | V1（改善前） | V2（改善後） | 改善量 |
|--------|------|--------|------------|------------|--------|
| **Article** | 13 | 14 | 14 | 14 | 0 |
| **Paragraph** | 13 | 37 | **113** | **86** | **-27** |
| **Item** | 0 | 86 | 0 | 0 | 0 |
| **List** | 593 | 38 | 484 | 512 | +28 |

### 改善率

#### Paragraph要素の過剰作成
- **V1**: 113個（過剰: +76個、**206%**）
- **V2**: 86個（過剰: +49個、**132%**）
- **改善**: 27個削減（**35.5%改善**）

#### List要素の保持
- **V1**: 484個保持
- **V2**: 512個保持（+28個）
- **改善**: より多くのList要素をItem特化処理用に適切に保持

#### 変換率
- **V1**: 109/593 = **18.4%**変換
- **V2**: 81/593 = **13.7%**変換
- **改善**: より選別的な変換を実現（**4.7ポイント減少**）

---

## 3. 統計詳細

### V1（改善前）の統計
```
処理したArticle: 13個
分割したArticle: 1個
作成したParagraph: 99個
変換したList: 108個
保持したList: （記録なし）
```

### V2（改善後）の統計
```
処理したArticle: 13個
分割したArticle: 1個
作成したParagraph: 72個  ← 27個削減
変換したList: 80個       ← 28個削減
保持したList: 512個      ← 新規追加（Item特化処理用）
```

---

## 4. 成功した点

### ✅ 連続番号判定の実装

1. **括弧付き数字の除外**: `（１）`, `（２）`などはParagraphに変換されなくなった
2. **連続性チェック**: `１→２→３`のような連続番号のみがParagraphに変換される
3. **Item候補の保持**: 連続していない数字や括弧付き数字は保持され、Item特化処理で処理される

### ✅ Article分割の安定性

- V1、V2ともに14個のArticleを正常に作成
- 「第○」パターンによる分割が正常に動作

### ✅ 過剰変換の削減

- Paragraph要素の過剰作成を**27個削減**（35.5%改善）
- より選別的な変換により、Item特化処理の負担を軽減

---

## 5. 残る課題

### ⚠️ Paragraph要素の過剰作成（+49個）

**現状:**
- 期待値: 37個
- 実際: 86個
- 過剰: **+49個（132%）**

**想定される原因:**

#### 原因1: 既存Paragraphの重複カウント

`test_input5.xml`には既に13個のParagraph要素が存在します。これらが保持され、さらに新しいParagraphが作成されるため、重複カウントの可能性があります。

**検証が必要:**
- 既存の13個のParagraphは保持されているか？
- 新規作成は本当に72個か？（86 - 13 = 73個）

#### 原因2: 連続性判定の誤検出

連続性判定がまだ十分でない可能性：
- 空のParagraphNum → `１` → `２`のパターン
- 複数のArticle間での連続性の混同
- 半角・全角の混在による判定ミス

#### 原因3: 期待値の構造差

`test_output5.xml`の37個のParagraphには：
- 既存の13個（入力からの保持）
- 新規作成の24個（List→Paragraph変換）

V2の86個には：
- 既存の13個？
- 新規作成の73個（過剰: +49個）

**計算:**
- 新規作成の期待値: 37 - 13 = **24個**
- 新規作成の実際: 86 - 13 = **73個**
- 過剰な新規作成: 73 - 24 = **49個**

---

## 6. 次のアクションアイテム

### 優先度: 高

#### 1. 詳細なログ出力の追加

連続性判定の詳細をログに記録：
```python
# どのラベルが連続と判定されたか
print(f"  ラベル '{label}' は連続: {is_continuous}")
print(f"  前のParagraphNums: {paragraph_nums_in_article}")

# どのラベルが保持されたか
print(f"  ラベル '{label}' は保持（Item特化処理用）")
```

#### 2. 既存Paragraphの処理確認

- 既存のParagraphは正しく保持されているか？
- Paragraph内のList要素のみが処理されているか？
- 既存ParagraphのParagraphNumが正しくリストに追加されているか？

#### 3. 具体的なケース分析

`test_input5.xml`と`test_input5_article_v2.xml`を比較：
- どのList要素がParagraphに変換されたか
- どのList要素が保持されたか
- 連続性判定がどのように動作したか

### 優先度: 中

#### 4. エッジケースの処理

- 空のParagraphNum後の`１`の扱い
- Article分割後の連続性リセット
- 全角・半角混在の扱い

#### 5. Item特化処理との統合テスト

- Article特化処理 → Item特化処理の連続実行
- 最終的な要素数の確認
- 期待値との比較

---

## 7. 推奨される次のステップ

### ステップ1: 詳細ログの有効化（即座に実行可能）

`convert_article_focused.py`にデバッグログを追加：
```python
# --debug フラグの追加
# 各判定の詳細をログに記録
```

### ステップ2: 具体例の分析（重要）

`test_input5.xml`の特定のArticle（例: Article[0]）を詳細に分析：
1. 元のParagraphとList要素の構造
2. 変換後のParagraph要素
3. どのList要素が変換/保持されたか

### ステップ3: Item特化処理の実行

Article特化処理の出力（`test_input5_article_v2.xml`）を入力として：
```bash
python convert_item_focused.py test_input5_article_v2.xml test_input5_full_v2.xml
```

### ステップ4: 最終比較

全処理完了後の`test_input5_full_v2.xml`と`test_output5.xml`を比較。

---

## 8. 結論

### 大幅な改善を達成

✅ **連続番号判定の実装**: 括弧付き数字の除外と連続性チェックにより、より選別的な変換を実現

✅ **過剰変換の削減**: Paragraph要素の過剰作成を27個削減（35.5%改善）

✅ **適切な保持**: Item特化処理用に512個のList要素を保持

### 残る課題

⚠️ **Paragraph過剰作成**: 期待値37個に対し86個（+49個）

⚠️ **詳細な原因分析が必要**: 既存Paragraphの扱い、連続性判定の精度

### 推奨される方向性

1. **詳細ログの追加** → 判定プロセスの可視化
2. **具体例の分析** → 問題箇所の特定
3. **Item特化処理との統合** → 全体的な動作確認
4. **段階的な改善** → 各問題に対する個別の修正

連続番号判定の実装により、Article特化処理は**大幅に改善**されました。残る課題はあるものの、基本的なロジックは正しく動作しています。

---

## 9. 技術的詳細

### 連続番号判定のアルゴリズム

```
入力: 現在のラベル（例: "２"）、前のParagraphNumのリスト（例: ["１"]）

処理:
1. 現在のラベルを整数に変換（"２" → 2）
2. 前のParagraphNumリストが空の場合:
   - 現在のラベルが"１"または"1"ならTrue（最初のParagraph）
   - それ以外はFalse
3. 前のParagraphNumリストが空でない場合:
   a. 最後のParagraphNumを取得
   b. 最後のParagraphNumが空の場合:
      - 現在のラベルが"１"または"1"ならTrue
      - それ以外はFalse
   c. 最後のParagraphNumが空でない場合:
      - 最後のParagraphNumを整数に変換（"１" → 1）
      - 現在の整数 == 最後の整数 + 1 ならTrue（連続）
      - それ以外はFalse（非連続）

出力: True（連続）またはFalse（非連続）
```

### 統計記録の強化

**V1:**
```python
self.stats = {
    'articles_split': 0,
    'articles_processed': 0,
    'paragraphs_created': 0,
    'lists_converted': 0,
}
```

**V2:**
```python
self.stats = {
    'articles_split': 0,
    'articles_processed': 0,
    'paragraphs_created': 0,
    'lists_converted': 0,
    'lists_skipped': 0,  # 新規追加
}
```

---

**作成日**: 2025年10月28日  
**スクリプト**: `convert_article_focused.py` V2  
**入力ファイル**: `test_input5.xml`  
**出力ファイル**: `test_input5_article_v2.xml`  
**改善内容**: 連続番号判定の実装

