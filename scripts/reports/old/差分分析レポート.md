# test_output5.xml と test_output5_final.xml の差分分析レポート

**分析日時**: 2025-10-27  
**分析対象**: 
- `test_output5.xml` (期待値)
- `test_output5_final.xml` (convert_list_unified.py実行結果)

---

## 📊 基本統計

### ファイルサイズと行数

| 項目 | test_output5.xml | test_output5_final.xml | 差分 |
|------|------------------|------------------------|------|
| **ファイルサイズ** | 336KB | 316KB | -20KB |
| **行数** | 4,827行 | 4,956行 | +129行 |
| **差分行数** | - | - | **9,752行** |

### 主要要素数の比較

| 要素タイプ | test_output5.xml | test_output5_final.xml | 差分 | 増減率 |
|-----------|------------------|------------------------|------|--------|
| **Article** | 28 | 28 | 0 | 0% |
| **Paragraph** | 105 | 100 | -5 | -4.8% |
| **Item** | 252 | 321 | +69 | +27.4% |
| **Subitem1** | 213 | 84 | -129 | -60.6% ⚠️ |
| **Subitem2** | 246 | 249 | +3 | +1.2% |
| **Subitem3** | 291 | 684 | +393 | +135% ⚠️⚠️ |
| **List** | 74 | 258 | +184 | +249% ⚠️⚠️ |

---

## 🔍 主要な差分パターン

### 1. XML宣言とスキーマパスの違い

**test_output5.xml:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Law Era="Reiwa" Year="5" Num="1" LawType="MinisterialOrdinance" Lang="ja" 
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
     xsi:noNamespaceSchemaLocation="../../schema/kokuji20250320_asukoe.xsd">
```

**test_output5_final.xml:**
```xml
<?xml version='1.0' encoding='utf-8'?>
<Law xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
     Era="Reiwa" Year="5" Num="1" LawType="MinisterialOrdinance" Lang="ja" 
     xsi:noNamespaceSchemaLocation="../../../schema/kokuji20250320_asukoe.xsd">
```

**差異**: 
- エンコーディング表記: `UTF-8` → `utf-8`
- 属性の順序が異なる
- スキーマパス: `../../` → `../../../`

**原因**: Python `ET.write()`のデフォルト動作

---

### 2. インデント・整形の違い

**test_output5.xml**: 2スペースインデント、空白行あり
**test_output5_final.xml**: 2スペースインデント、空白行なし

**原因**: `ET.indent()`の動作の違い

---

### 3. 構造的な重大な差異

#### 差異A: 第１節の構造が全く異なる

**test_output5.xml (期待値):**
```xml
<Section Num="1">
  <SectionTitle>第１節　教育目標</SectionTitle>
  <Article Num="1">
    <ArticleTitle/>
    <Paragraph Num="1">
      <ParagraphNum/>
      <ParagraphSentence>
        <Sentence>高等部における教育については，...</Sentence>
      </ParagraphSentence>
      <Item Num="1">
        <ItemTitle>１</ItemTitle>
        <ItemSentence>学校教育法第５１条に規定する...</ItemSentence>
      </Item>
      <Item Num="2">
        <ItemTitle>２</ItemTitle>
        <ItemSentence>生徒の障害による学習上又は...</ItemSentence>
      </Item>
    </Paragraph>
  </Article>
</Section>
```

**test_output5_final.xml (実際の出力):**
```xml
<Section Num="1">
  <SectionTitle>第１節　教育目標</SectionTitle>
  <Article Num="1">
    <ArticleTitle />
    <Paragraph Num="1">
      <ParagraphNum />
      <ParagraphSentence>
        <Sentence>高等部における教育については，...</Sentence>
      </ParagraphSentence>
      <Item Num="1">
        <ItemTitle>１</ItemTitle>
        <ItemSentence>学校教育法第５１条に規定する...</ItemSentence>
      </Item>
      <Item Num="2">
        <ItemTitle>２</ItemTitle>
        <ItemSentence>生徒の障害による学習上又は...</ItemSentence>
      </Item>
    </Paragraph>
  </Article>
</Section>
```

**差異**: 第１節については両者がほぼ一致！

---

#### 差異B: 第２節第１款の構造が大きく異なる

**test_output5.xml (期待値):**
- Paragraph内にItemがネストされている
- ItemTitle: `１`, `２`, `３`, ...

**test_output5_final.xml (実際の出力):**
- 複数のParagraphに分割されている
- ItemTitle: `（１）`, `（２）`, `（３）`, ...
- Item直下にListが追加されている（長文の説明文）

**例（Paragraph Num="2"）:**

**期待値:**
```xml
<Item Num="1">
  <ItemTitle>１</ItemTitle>
  <ItemSentence>基礎的・基本的な知識及び技能を...</ItemSentence>
</Item>
```

**実際の出力:**
```xml
<Item Num="1">
  <ItemTitle>（１）</ItemTitle>
  <ItemSentence>基礎的・基本的な知識及び技能を...</ItemSentence>
</Item>
<Item Num="2">
  <ItemTitle>（２）</ItemTitle>
  <ItemSentence>道徳教育や体験活動，...</ItemSentence>
  <List>
    <ListSentence>
      <Sentence>学校における道徳教育は，...</Sentence>
    </ListSentence>
  </List>
  <List>...</List>
  <List>...</List>
</Item>
```

**差異**: 
- ラベルの形式が異なる（`１` vs `（１）`）
- 実際の出力には、長文説明文がList要素として保持されている

---

#### 差異C: SubitemレベルのネストDepthが異なる

**Subitem1の減少とSubitem3の増加**:

| 要素 | 期待値 | 実際 | 差分 |
|------|--------|------|------|
| Subitem1 | 213 | 84 | -129 (-60.6%) |
| Subitem3 | 291 | 684 | +393 (+135%) |

**原因**:
既存の`convert_subject_structure()`と`convert_paragraph_structure()`が、異なる階層判定ロジックを使用している。

**期待値の変換ロジック**:
- 数字タイトル（`１`, `２`）→ Subitem1
- 括弧数字（`（１）`, `（２）`）→ Subitem2
- カタカナ（`ア`, `イ`）→ Subitem3

**実際の変換ロジック**:
- 科目構造内では異なる階層判定
- より深い階層（Subitem3）を優先的に使用

---

## 🎯 差異の主要原因

### 1. 入力ファイルの違い（可能性）

**仮説**: `test_output5.xml`と`test_output5_final.xml`は、**同一の入力ファイル**から生成されたものではない可能性がある。

**根拠**:
- 構造的な差異が非常に大きい
- ラベル形式が異なる（`１` vs `（１）`）
- 長文説明文の扱いが異なる

**検証が必要**: `test_output5.xml`の生成に使用された入力ファイルを確認

---

### 2. 変換ロジックの違い

**既存の`convert_list_unified.py`のロジック**:
- 科目構造（`〔科目名〕`）に特化した変換
- Paragraph構造の基本的な変換
- 階層判定は簡易版（3階層）

**`test_output5.xml`の生成に使用されたロジック**:
- より洗練された階層判定
- ラベル形式の正規化（`１` → `（１）`への変換）
- 長文説明文のSubitem化（Listとして残さない）

---

### 3. Phase 0-3の実装の影響

**Phase 0（Article分割）**:
- ✅ 正常に動作（Article数は一致: 28個）
- 「第１」→「第２」の分割は正しく実行されている

**Phase 1-3（階層判定関数等）**:
- ⚠️ 関数は実装済みだが、既存の変換ロジックに統合されていない
- `get_hierarchy_level()`、`determine_element_type()`等は未使用

**結果**:
既存の簡易的な階層判定ロジックがそのまま使用されているため、期待値と異なる階層構造が生成されている。

---

## 📋 詳細な差分箇所

### 差分が大きい箇所（上位5箇所）

1. **Section 2, Subsection 1, Article 1**: 大量のList要素が追加
   - 期待値: Item内にテキストのみ
   - 実際: Item内にList要素が多数追加

2. **科目構造（〔医療と社会〕等）**: 階層Depthの違い
   - 期待値: Subitem1 → Subitem2 → Subitem3
   - 実際: Item → Subitem1 → Subitem3（Subitem1を飛ばす）

3. **ラベル形式の違い**: 全体的
   - 期待値: `１`, `２`, `３`
   - 実際: `（１）`, `（２）`, `（３）`または`１`, `２`, `３`（混在）

4. **Paragraph分割の違い**: 
   - 期待値: 1つのParagraph内に全てのItemを配置
   - 実際: 複数のParagraphに分割（ParagraphNum: `１`, `２`, `３`, ...）

5. **List要素の残存**: 
   - 期待値: 74個のList
   - 実際: 258個のList（+184個）

---

## ✅ 一致している箇所

1. **Article数**: 28個（完全一致）
2. **Article分割**: 「第１」→「第２」は正しく分割されている
3. **基本的なテキスト内容**: ほぼ一致（変更なし）
4. **全体的な構造の枠組み**: Chapter, Section, Subsectionは一致

---

## 🔧 差異を解消するために必要な対応

### 優先度: 高

1. **階層判定ロジックの完全統合**
   - `get_hierarchy_level()`と`determine_element_type()`を既存の変換ロジックに統合
   - 推定時間: 1-2日

2. **ラベル形式の正規化**
   - `１`, `２` → `（１）`, `（２）`への変換ルール追加
   - 推定時間: 半日

3. **長文説明文の処理改善**
   - List要素として残すのではなく、Subitem化する
   - 推定時間: 1日

### 優先度: 中

4. **Paragraph分割ロジックの見直し**
   - 数字ラベル（`１`, `２`）での新しいParagraph作成ルールの精緻化
   - 推定時間: 1日

5. **科目構造の階層判定の改善**
   - `convert_subject_structure()`の階層判定を完全版に更新
   - 推定時間: 1日

### 優先度: 低

6. **XML整形の統一**
   - 空白行の扱い、属性の順序の統一
   - 推定時間: 半日

---

## 📌 結論

### 差異の性質

**test_output5.xml**（期待値）と**test_output5_final.xml**（実際の出力）の差異は、**変換ロジックの設計思想の違い**によるものです。

### 主要な違い

1. **階層判定ロジック**: 簡易版（3階層）vs 完全版（6階層以上）
2. **ラベル形式**: 混在 vs 統一
3. **長文処理**: List保持 vs Subitem化
4. **Paragraph分割**: 多分割 vs 少分割

### Phase 0-3の実装の評価

✅ **Article分割機能は正常に動作**  
⚠️ **階層判定関数は実装済みだが未統合**

### 今後の対応

1. **短期**: 階層判定関数の統合（1-2日）
2. **中期**: ラベル形式の正規化、長文処理の改善（1-2日）
3. **長期**: 完全な期待値との一致（3-5日）

---

## 📊 統計サマリー

| 項目 | 値 |
|------|-----|
| **差分行数** | 9,752行 |
| **一致率（Article数）** | 100% (28/28) |
| **一致率（全体構造）** | 約60-70%（推定） |
| **主要な差異要因** | 階層判定ロジックの違い |
| **解消推定時間** | 3-5日（完全一致を目指す場合） |

---

**報告日**: 2025-10-27  
**作成者**: AI Assistant  
**ファイル**: `/Users/fukushima/Documents/xml_anken/gyosei-xml/scripts/education_script/差分分析レポート.md`

