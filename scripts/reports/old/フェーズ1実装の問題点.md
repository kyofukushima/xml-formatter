# フェーズ1実装の問題点

## 📅 作成日
2025年10月27日

## 🎯 フェーズ1の目標

1. ✅ `determine_element_type()`を親ベース優先判定に変更
2. ✅ `convert_lists_to_subitems_with_parent()`を追加
3. ✅ Phase 2.5-6〜11でSubitem5-10の処理を追加

## ❌ 実装結果

### 要素数（変化なし）

| 要素 | 実際 | 期待 | 差分 | 状態 |
|-----|-----|-----|------|-----|
| Subitem5 | **0個** | 166個 | **-166個** | ❌ 未改善 |
| Subitem4 | 13個 | 67個 | -54個 | ❌ 未改善 |
| Subitem3 | **241個** | 97個 | **+144個** | ❌ 未改善 |
| Subitem2 | 120個 | 82個 | +38個 | ❌ 未改善 |

**一致率: 31.5%（変化なし）**

---

## 🔍 問題の分析

### 発見1: test_input5.xmlとtest_output5.xmlの構造的な不一致

**test_input5.xml:**
```
Paragraph内の連続するList要素:
  List[0]: 「２」        （カラムあり、level 1: 数字）
  List[1]: 「（１）」    （カラムあり、level 2: 括弧数字）
  List[2]: 「ア」        （カラムあり、level 3: カタカナ）
```

**test_output5.xml:**
```
Item「(空)」
  └─ Subitem1「２」
      └─ Subitem2「(空)」  ← ★ 対応するList要素なし
          └─ Subitem3「(空)」  ← ★ 対応するList要素なし
              └─ Subitem4「（１）」
                  └─ Subitem5「ア」
```

**問題:**
- test_input5.xmlの2つの連続するList要素（「２」と「（１）」）
- test_output5.xmlでは5レベルの深い階層に変換
- 間に2つの空のラベルの中間階層が挿入されている
- **これらの中間階層に対応するList要素がtest_input5.xmlに存在しない**

### 発見2: 現在のロジックの動作

**現在の変換:**
```
「（１）」（level 4: 括弧カタカナ）
  → next_depth = max(0, 4 - 2) = 2
  → 親がItem、current_depth=2
  → determine_element_type()が'Subitem2'を返す
  → 実際にSubitem2として作成される
```

**期待される変換:**
```
「（１）」（level 4: 括弧カタカナ）
  → 親がSubitem3、current_depth=3
  → determine_element_type()が'Subitem4'を返す
  → Subitem4として作成される
```

**ギャップ:**
- 現在の親: Item（depth=0）
- 期待される親: Subitem3（depth=3）
- **差: 3レベル**

### 発見3: 「ア」ラベルの配置

**現在の配置:**
- Subitem1「ア」: 8個（親はItem）
- Subitem3「ア」: 62個（親はSubitem2）

**期待される配置:**
- Subitem5「ア」: 166個（親はSubitem4）

**ギャップ:**
- 現在: Subitem1 or Subitem3
- 期待: Subitem5
- **差: 2〜4レベル浅い**

---

## 🤔 問題の核心

### 仮説1: test_output5.xmlは手動編集されたもの

- 空のラベルの中間階層（Subitem2, Subitem3）が手動で挿入された
- test_input5.xmlには対応するList要素が存在しない
- → **私たちのスクリプトでは同じ構造を再現できない**

### 仮説2: 中間階層の自動挿入ロジックが必要

- ラベルのレベル差から中間階層を自動的に挿入するロジックが存在する
- 例: level 1 → level 2の間に、中間の空要素を2つ挿入
- → **このロジックがまだ実装されていない**

### 仮説3: test_input5.xmlの解釈が間違っている

- Column構造なしのList要素が中間階層を表している
- または、別の要素（TableStruct等）が中間階層を表している
- → **私たちが見落としている構造がある**

### 仮説4: ラベルのレベルと最終的なSubitemレベルは直接対応しない

- level 1（数字）→ 必ずSubitem1ではない
- level 2（括弧数字）→ 必ずSubitem2ではない
- 文脈（前後のラベル、階層の深さ）によって動的に決定される
- → **より複雑な判定ロジックが必要**

---

## 📊 データポイント

### test_output5.xmlの分析

**Subitem5の特徴:**
- 総数: 166個
- 親: 全てSubitem4
- ラベル: カタカナ（ア、イ、ウ、エ、オ...）
- 深さ: 10レベル（非常に深い）

**Subitem4の特徴:**
- 総数: 67個
- 親: 様々（Subitem3が最も多い）
- ラベル: 括弧数字（（１）、（２）...）やアルファベット

**空のラベルのSubitem:**
- Subitem2「(空)」: 多数存在
- Subitem3「(空)」: 多数存在
- → **これらがキーとなる中間階層**

### test_input5.xmlの分析

**「（１）」ラベルの出現パターン:**
```
直前のラベル:
  - 「２」（数字）: 多数
  - 「（ケ）」（括弧カタカナ）: 一部
  - なし: 一部
```

**「ア」ラベルの出現パターン:**
```
直前のラベル:
  - 「（１）」（括弧数字）: 最も多い
  - 「（２）」（括弧数字）: 多数
  - その他: 様々
```

---

## 🎯 次の方針の選択肢

### 選択肢A: test_output5.xmlを「理想形」として、中間階層自動挿入ロジックを実装

**アプローチ:**
1. ラベルのレベル差を分析
2. レベル差が2以上の場合、中間に空のSubitemを自動挿入
3. 深さを段階的に増やす

**メリット:**
- test_output5.xmlとの一致率が向上する可能性

**デメリット:**
- 複雑なロジックが必要
- 空のラベルの要素が大量に生成される
- 本当に正しいアプローチか不明

### 選択肢B: test_output5.xmlの構造を再確認し、別のパターンを探す

**アプローチ:**
1. test_output5.xmlの他の部分も詳しく分析
2. 空のラベルの中間階層が常に存在するか確認
3. 別のパターンやルールが存在するか探索

**メリット:**
- より正確な理解が得られる
- 正しいロジックを実装できる

**デメリット:**
- 時間がかかる
- 明確な答えが見つからない可能性

### 選択肢C: 現在のロジックを改善し、「合理的な」階層構造を作成

**アプローチ:**
1. 中間階層の自動挿入はせず、直接的な親子関係のみを作成
2. 「２」→ Subitem1、「（１）」→ Subitem2（Subitem1の子）
3. 「ア」→ Subitem3（Subitem2の子）
4. test_output5.xmlとは異なるが、論理的に一貫した構造

**メリット:**
- シンプルで理解しやすい
- デバッグが容易
- 拡張性が高い

**デメリット:**
- test_output5.xmlとの一致率は低いまま
- 期待される出力と異なる

### 選択肢D: ユーザーに確認

**質問:**
1. test_output5.xmlは手動編集されたものですか？
2. 空のラベルの中間階層は自動的に挿入されるべきですか？
3. test_input5.xmlに対応するList要素が存在しますか？
4. 期待される変換ロジックの詳細を教えていただけますか？

---

## 💡 推奨される次のステップ

**即座のアクション:**
1. test_output5.xmlの他の部分（特に空のラベルのSubitem）を詳しく分析
2. 空のラベルのSubitemに対応するtest_input5.xmlの要素を探索
3. パターンが見つかれば、それに基づいてロジックを実装

**中期的なアクション:**
1. 選択肢Cのアプローチで、シンプルだが論理的に一貫した構造を作成
2. 一致率は低くても、デバッグ可能で拡張可能な基盤を構築
3. 段階的に改善

**長期的なアクション:**
1. test_output5.xmlの作成方法を理解
2. 正しいロジックを特定
3. 完全な一致を目指す

---

## 📌 現在の状態

- ✅ 親ベース判定ロジックは実装済み（Subitemの子は親+1）
- ✅ Subitem5-10の処理は追加済み
- ❌ しかし、中間階層が不足しているため効果なし
- ❌ 根本的な構造の理解が必要

**次に必要なこと:**
→ test_output5.xmlの空のラベルの中間階層の正体を解明する

