# ラベル分離ロジック実装サマリー

**実装日**: 2025年10月27日

---

## 📋 実装内容

### 新規追加された機能

#### 1. `split_label_and_text()` メソッド

**ファイル**: `convert_list_unified.py`（134-191行目）

**機能**: 1つのSentence要素内に「ラベル＋スペース＋テキスト」が混在している場合、これを分離する。

**入力形式:**
```xml
<Sentence>（ウ）　主として専門学科において開設される各教科・科目</Sentence>
```

**出力形式:**
```python
label, text = split_label_and_text("（ウ）　主として専門学科において...")
# → ("（ウ）", "主として専門学科において...")
```

**サポートされるラベルパターン（6種類）:**
1. 数字: `１`, `２`, `３`
2. 括弧数字: `（１）`, `（２）`
3. カタカナ: `ア`, `イ`, `ウ`
4. 括弧カタカナ: `（ア）`, `（イ）`
5. 二重括弧カタカナ: `（（ア））`, `（（イ））`
6. アルファベット: `a`, `b`, `c`

**特徴:**
- 全角スペース（`　`）と半角スペース（` `）の両方に対応
- ラベルが存在しない場合は `(None, 元のテキスト)` を返却
- 正規表現による高精度なパターンマッチング

---

## ✅ テスト結果

### テストファイル
`test_split_label.py`

### テスト内容
11個のテストケースを実行：
- 6種類のラベルパターン（全角スペース）
- 2種類のラベルパターン（半角スペース）
- ラベルなしのテキスト（2種類）

### テスト結果
**✅ 全11個のテストケースが成功（成功率: 100%）**

```
テスト結果: 11個成功, 0個失敗
```

---

## 📚 ドキュメント更新

### 1. `修正ロジック分析.md`

**追加箇所**: ルール2の直後に「2-1. ラベルとテキストの分離処理」を追加

**内容:**
- ラベル分離処理の詳細説明
- サポートされる6種類のラベルパターン
- 実装例（Pythonコード）
- 変換例（XML形式）× 2種類
- 重要な注意点

### 2. `実装戦略分析.md`

**追加箇所1**: Phase 0とPhase 1の間に「Phase 0.5: ラベルとテキストの分離処理」を追加

**内容:**
- ラベル分離関数の実装例
- Column構造なしList要素の処理拡張
- ParagraphSentence内のラベル+テキスト処理
- 実装時間の見積もり（1日）
- 重要なポイント

**追加箇所2**: 実装スケジュールを更新

| フェーズ | 内容 | 実装時間 | 累積 |
|---------|------|---------|------|
| Phase 0 | Article分割 + Num振り直し | 1-2日 | 1-2日 |
| **Phase 0.5** | **ラベルとテキストの分離処理** | **1日** | **2-3日** |
| Phase 1 | 階層判定の完全実装 | 2-3日 | 4-6日 |
| Phase 2 | 複雑パターンの実装 | 3-4日 | 7-10日 |
| Phase 3 | 角括弧科目名の完全実装 | 1-2日 | 8-12日 |
| テスト | 統合テスト + デバッグ | 2日 | **10-14日** |

**追加箇所3**: 実装進捗セクションに「Phase 0.5の実装完了」を追加

---

## 🔧 実装の詳細

### メソッドシグネチャ

```python
def split_label_and_text(self, text: str) -> Tuple[Optional[str], Optional[str]]:
    """ラベルとテキストを分離する
    
    Args:
        text: 分離対象のテキスト
    
    Returns:
        Tuple[Optional[str], Optional[str]]: (ラベル, 残りのテキスト)
        ラベルがない場合は (None, 元のテキスト)
    """
```

### 正規表現パターン

1. **数字**: `^([0-9０-９]+)[\s　]+(.+)$`
2. **括弧数字**: `^([（(][0-9０-９]+[）)])[\s　]+(.+)$`
3. **カタカナ**: `^([ア-ヴ]+)[\s　]+(.+)$`
4. **括弧カタカナ**: `^([（(][ア-ヴ]+[）)])[\s　]+(.+)$`
5. **二重括弧カタカナ**: `^([（(]{2}[ア-ヴ]+[）)]{2})[\s　]+(.+)$`
6. **アルファベット**: `^([a-z]+)[\s　]+(.+)$`

**共通の特徴:**
- `[\s　]+`: 全角・半角スペース1つ以上
- キャプチャグループ: `()` でラベルとテキストを分離
- 後方参照: `match.group(1)` がラベル、`match.group(2)` がテキスト

---

## 💡 使用例

### 例1: Column構造なしList要素の処理

```python
# List要素からテキストを抽出
list_elem = ...  # <List><ListSentence><Sentence>（ウ）　テキスト</Sentence></ListSentence></List>
sentence = list_elem.find('.//Sentence')
text = ''.join(sentence.itertext()).strip()

# ラベルとテキストを分離
label, remaining_text = self.split_label_and_text(text)

if label is not None:
    # ラベルあり: Item/Subitem要素に変換
    # label → Title要素
    # remaining_text → Sentence要素
    ...
else:
    # ラベルなし: List要素として保持
    ...
```

### 例2: ParagraphSentence内のラベル+テキストの処理

```python
# ParagraphSentence内のテキストを抽出
para_sentence = paragraph.find('./ParagraphSentence')
sentence = para_sentence.find('./Sentence')
text = ''.join(sentence.itertext()).strip()

# ラベルとテキストを分離
label, remaining_text = self.split_label_and_text(text)

if label is not None:
    # ラベルあり: Paragraphから適切な階層要素（Item/Subitem）に変換
    hierarchy_level = self.get_hierarchy_level(label)
    # ... 階層判定ロジックを適用 ...
```

---

## 🎯 今後の統合予定

### Phase 2での統合

**対象処理:**
- Column構造を持たないList要素の変換拡張
- 既存のParagraphSentence内のラベル+テキスト処理

**統合方法:**
1. `convert_paragraph_structure()` メソッド内で `split_label_and_text()` を呼び出し
2. ラベルが検出された場合、既存の階層判定ロジック（`get_hierarchy_level()`、`determine_element_type()`）を適用
3. 適切な要素（Item/Subitem）を作成し、親要素に配置

**処理タイミング:**
- ParagraphSentence補完（ルール4）の**後**
- List+Column変換（ルール2）と**統合**または**並行**

---

## 📊 期待される効果

1. **Column構造なしList要素の処理向上**
   - 現在は保持されているラベル+テキスト混在要素を適切に分離
   - 階層構造への変換が可能になる

2. **ParagraphSentence内の誤った構造の修正**
   - test_input5.xml の911行目、1045行目、1107行目のようなパターンに対応
   - ParagraphSentence内にラベルとテキストが混在している場合の自動分離

3. **変換精度の向上**
   - 全角・半角スペースの両方に対応
   - 6種類のラベルパターンを網羅
   - 誤判定のリスクを最小化

4. **コードの再利用性**
   - 単一の関数で全てのラベル分離処理を実装
   - 既存の階層判定ロジックとの統合が容易

---

## ✅ 結論

**Phase 0.5（ラベルとテキストの分離処理）の実装が完了しました。**

**実装内容:**
- ✅ `split_label_and_text()` メソッドの追加（convert_list_unified.py）
- ✅ 6種類のラベルパターンのサポート
- ✅ 全角・半角スペースへの対応
- ✅ 11個のテストケース（100%成功）
- ✅ ドキュメントの更新（修正ロジック分析.md、実装戦略分析.md）

**実装時間:** 約20分

**次のステップ:**
- Phase 2での変換処理への統合（必要に応じて実施）
- 実際のXMLファイルでの動作検証

---

**作成日**: 2025年10月27日  
**ファイル**: `/Users/fukushima/Documents/xml_anken/gyosei-xml/scripts/education_script/ラベル分離実装サマリー.md`

