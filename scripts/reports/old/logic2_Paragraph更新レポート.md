# logic2_Paragraph.markdown 更新レポート

## 実施日
2025年10月28日

## 概要
`logic2_Paragraph.markdown`の項目ラベルパターン一覧を、`修正ロジック分析.md`に基づいて大幅に拡充しました。

---

## 1. 更新内容

### 1.1. 追加した項目ラベルパターン

**元のパターン数: 7個**  
**更新後のパターン数: 14個**（+7個）

#### 新規追加したパターン

| パターン名 | 正規表現 | 例 | 変換先候補 |
|-----------|---------|-----|-----------|
| **二重括弧カタカナ** | `^[（(]{2}[ア-ヴ]+[）)]{2}$` | （（ア））、（（イ））、((ア))、((イ)) | Subitem3 / Subitem4 |
| **全角小文字アルファベット** | `^[ａ-ｚ]+$` | ａ、ｂ、ｃ | Subitem3 / Subitem4 |
| **大文字アルファベット** | `^[A-Z]+$` | A、B、C | Subitem3 / Subitem4 |
| **全角大文字アルファベット** | `^[Ａ-Ｚ]+$` | Ａ、Ｂ、Ｃ | Subitem3 / Subitem4 |
| **括弧小文字アルファベット** | `^[（(][a-z]+[）)]$` | （a）、（b）、(a)、(b) | Subitem4 / Subitem5 |
| **括弧全角小文字アルファベット** | `^[（(][ａ-ｚ]+[）)]$` | （ａ）、（ｂ）、(ａ)、(ｂ) | Subitem4 / Subitem5 |
| **第○パターン** | `^第[0-9０-９一二三四五六七八九十百千]+$` | 第１、第２、第一、第二 | Article（分割） |

### 1.2. 修正した既存パターン

#### カタカナの範囲拡張

**修正前:**
```regex
^[ア-ン]+$
```

**修正後:**
```regex
^[ア-ヴ]+$
```

**理由:** 「ヴ」を含めるため（例: ヴァイオリン、ヴィジョン等の外来語対応）

#### 正規表現の統一

数字の正規表現を統一：

**修正前:**
```regex
^[０-９\d]+$
```

**修正後:**
```regex
^[０-９0-9]+$
```

**理由:** `\d`は文脈によって解釈が異なる可能性があるため、明示的に`0-9`を使用

---

## 2. 新規追加セクション

### 2.1. 階層レベルの順序

項目ラベルの階層関係を明確化：

| 階層レベル | ラベルの種類 | XML要素の目安 |
|----------|------------|---------------|
| **0** | 第○パターン | `Article`（分割） |
| **1** | 数字 | `Paragraph` または `Item` |
| **2** | 括弧数字 | `Item` または `Subitem1` |
| **3** | カタカナ | `Subitem1` または `Subitem2` |
| **4** | 括弧カタカナ | `Subitem2` または `Subitem3` |
| **5** | 二重括弧カタカナ | `Subitem3` または `Subitem4` |
| **6** | アルファベット | `Subitem3` 以降 |
| **7** | 括弧アルファベット | `Subitem4` 以降 |

**重要な原則:**
- 数字が小さいほど**浅い階層**（上位）
- 数字が大きいほど**深い階層**（下位）

### 2.2. パターン判定の優先順位

正規表現マッチングの優先順位を定義：

1. **括弧科目名**（`〔XXX〕`）- 最優先
2. **第○パターン**（`第○`）- Article分割
3. **二重括弧カタカナ**（`（（ア））`）- より具体的なパターンから
4. **括弧アルファベット**（`（a）`）
5. **括弧カタカナ**（`（ア）`）
6. **括弧数字**（`（１）`）
7. **カタカナ**（`ア`）- 括弧なし
8. **アルファベット**（`a、A`）- 括弧なし
9. **数字**（`１`）- 括弧なし
10. **空** - 最後

**理由:** より具体的なパターン（括弧付き、二重括弧）を先にチェックすることで、誤判定を防ぐ

### 2.3. テーブルに「変換先候補」列を追加

各パターンがどのXML要素に変換される可能性があるかを明確化：

```markdown
| パターン名 | 正規表現 | 例 | 変換先候補 |
|-----------|---------|-----|-----------|
| **数字** | ... | ... | Paragraph / Item |
```

---

## 3. 更新前後の比較

### 3.1. パターン一覧の変化

#### 更新前（7パターン）

1. 数字
2. 括弧数字
3. カタカナ
4. 括弧カタカナ
5. 小文字アルファベット
6. 括弧科目名
7. 空

#### 更新後（14パターン）

1. 数字
2. 括弧数字
3. カタカナ
4. 括弧カタカナ
5. **二重括弧カタカナ** ← 新規
6. 小文字アルファベット
7. **全角小文字アルファベット** ← 新規
8. **大文字アルファベット** ← 新規
9. **全角大文字アルファベット** ← 新規
10. **括弧小文字アルファベット** ← 新規
11. **括弧全角小文字アルファベット** ← 新規
12. **第○パターン** ← 新規
13. 括弧科目名
14. 空

---

## 4. 実装への影響

### 4.1. convert_article_focused.py

**対応済み:**
- ✅ 「第○パターン」の検出と処理
- ✅ Article分割ロジック

### 4.2. convert_paragraph_focused.py（未実装）

**対応必要:**
- 数字パターンの検出
- Paragraph分割ロジック
- 連続番号判定

### 4.3. convert_item_focused.py（未実装）

**対応必要:**
- 括弧数字パターンの検出
- Item作成ロジック
- 階層判定

### 4.4. convert_subitem_focused.py（未実装）

**対応必要:**
- カタカナ、括弧カタカナ、二重括弧カタカナの検出
- アルファベット（全半角、括弧付き）の検出
- 深い階層への対応（Subitem1～Subitem10）

---

## 5. 正規表現の実装例

### 5.1. Python実装

```python
import re

def detect_label_pattern(label: str) -> str:
    """ラベルパターンを判定（優先順位順）"""
    
    # 1. 角括弧科目名（最優先）
    if re.match(r'^〔.+〕$', label):
        return 'subject_label'
    
    # 2. 第○パターン
    if re.match(r'^第[0-9０-９一二三四五六七八九十百千]+$', label):
        return 'article_marker'
    
    # 3. 二重括弧カタカナ（具体的なパターンから先にチェック）
    if re.match(r'^[（(]{2}[ア-ヴ]+[）)]{2}$', label):
        return 'double_paren_katakana'
    
    # 4. 括弧アルファベット（全角・半角）
    if re.match(r'^[（(][a-zａ-ｚ]+[）)]$', label):
        return 'paren_alphabet_lower'
    if re.match(r'^[（(][A-ZＡ-Ｚ]+[）)]$', label):
        return 'paren_alphabet_upper'
    
    # 5. 括弧カタカナ
    if re.match(r'^[（(][ア-ヴ]+[）)]$', label):
        return 'paren_katakana'
    
    # 6. 括弧数字
    if re.match(r'^[（(][0-9０-９]+[）)]$', label):
        return 'paren_number'
    
    # 7. カタカナ（括弧なし）
    if re.match(r'^[ア-ヴ]+$', label):
        return 'katakana'
    
    # 8. アルファベット（括弧なし、全角・半角）
    if re.match(r'^[a-z]+$', label):
        return 'alphabet_lower'
    if re.match(r'^[ａ-ｚ]+$', label):
        return 'alphabet_lower_fullwidth'
    if re.match(r'^[A-Z]+$', label):
        return 'alphabet_upper'
    if re.match(r'^[Ａ-Ｚ]+$', label):
        return 'alphabet_upper_fullwidth'
    
    # 9. 数字（括弧なし）
    if re.match(r'^[0-9０-９]+$', label):
        return 'number'
    
    # 10. 空
    if label == '':
        return 'empty'
    
    return 'unknown'
```

### 5.2. 階層レベル判定

```python
def get_hierarchy_level(label: str) -> int:
    """階層レベルを返す（0-7、小さいほど浅い）"""
    pattern = detect_label_pattern(label)
    
    hierarchy_map = {
        'article_marker': 0,        # 第○
        'number': 1,                # 数字
        'paren_number': 2,          # 括弧数字
        'katakana': 3,              # カタカナ
        'paren_katakana': 4,        # 括弧カタカナ
        'double_paren_katakana': 5, # 二重括弧カタカナ
        'alphabet_lower': 6,        # アルファベット（小文字）
        'alphabet_upper': 6,        # アルファベット（大文字）
        'alphabet_lower_fullwidth': 6,  # 全角アルファベット
        'alphabet_upper_fullwidth': 6,  # 全角アルファベット
        'paren_alphabet_lower': 7,  # 括弧アルファベット
        'paren_alphabet_upper': 7,  # 括弧アルファベット
        'subject_label': -1,        # 角括弧科目名（特殊）
        'empty': -1,                # 空（特殊）
    }
    
    return hierarchy_map.get(pattern, 999)  # 不明な場合は最深
```

---

## 6. メリット

### ✅ 網羅性の向上

- **7パターン → 14パターン**（2倍）
- 全角・半角の両方に対応
- 括弧付き・括弧なしの両方に対応

### ✅ 明確な階層定義

- 階層レベルを0～7で定義
- 数字が小さいほど浅い階層
- 実装時の判断基準が明確

### ✅ 優先順位の明確化

- より具体的なパターン（二重括弧、括弧付き）を優先
- 誤判定の防止
- 実装ガイドラインとして機能

### ✅ 実装との整合性

- `修正ロジック分析.md`と完全に整合
- Article特化スクリプトで既に実装済みのパターンを含む
- 今後のParagraph/Item/Subitem特化スクリプトへの指針

---

## 7. 今後の対応

### Phase 1: Paragraph特化スクリプト

**必要なパターン:**
- 数字
- 括弧数字（連続番号判定のため）

### Phase 2: Item特化スクリプト

**必要なパターン:**
- 数字（1から開始の判定）
- 括弧数字
- カタカナ
- 括弧科目名

### Phase 3: Subitem特化スクリプト

**必要なパターン:**
- カタカナ
- 括弧カタカナ
- 二重括弧カタカナ
- アルファベット（全種類）

### Phase 4: 統合テスト

- 全パターンの動作確認
- エッジケースのテスト
- test_output5.xmlとの比較

---

## 8. ファイル情報

**ファイルパス:**
```
/Users/fukushima/Documents/xml_anken/gyosei-xml/scripts/education_script/reports/logic2_Paragraph.markdown
```

**総行数:** 320行（変更なし）

**変更箇所:**
- 9～62行目（項目ラベルセクション）
  - パターン一覧の拡充
  - 階層レベルの順序セクション追加（新規）
  - パターン判定の優先順位セクション追加（新規）

---

## 9. まとめ

### ✅ 完了したこと

1. **項目ラベルパターンの拡充**
   - 7パターン → 14パターン（+7個）
   - 全角・半角、括弧付き・なしを網羅

2. **階層レベルの定義**
   - 0～7の階層レベルを定義
   - XML要素との対応関係を明確化

3. **優先順位の定義**
   - 正規表現マッチングの順序を明確化
   - 誤判定防止のガイドライン

4. **テーブル構造の改善**
   - 「変換先候補」列を追加
   - パターンの用途が一目で分かる

### 📝 参照元

- `修正ロジック分析.md`（2167行）
  - 52～81行目：階層順序の定義
  - 210～221行目：サポートされるパターン
  - 1339～1391行目：ラベルパターンの優先順位

### 🎯 次のステップ

1. **Paragraph特化スクリプトの実装**
   - 数字パターンの検出
   - 連続番号判定ロジック

2. **Item特化スクリプトの実装**
   - 括弧数字パターンの検出
   - 階層判定ロジック

3. **正規表現ユーティリティの共通化**
   - `utils/label_utils.py`の作成
   - 全スクリプトで共通利用

---

**実施者:** AI Assistant  
**作業日:** 2025年10月28日  
**ファイル:** `scripts/education_script/reports/logic2_Paragraph.markdown`  
**状態:** ✅ 完了


