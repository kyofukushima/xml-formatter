# 深さベースロジック実装における問題分析

## 実施日
2025年10月27日

## 問題の概要

深さベースロジックを実装したが、要素数が期待値と大きく乖離している。
特に**Subitem4/5が全く作成されない**という深刻な問題が発生している。

---

## 要素数比較

| 要素名 | 実際の値 | 期待値 | 差分 | 判定 |
|--------|---------|--------|------|------|
| Article | 14 | 14 | 0 | ✅ |
| Paragraph | 179 | 37 | +142 | ❌ |
| Item | 55 | 86 | -31 | ❌ |
| Subitem1 | 30 | 74 | -44 | ❌ |
| Subitem2 | 85 | 82 | +3 | ⚠️ |
| Subitem3 | 229 | 97 | +132 | ❌ |
| Subitem4 | 1 | 67 | -66 | ❌ |
| Subitem5 | 1 | 166 | -165 | ❌ |
| List | 25 | 38 | -13 | ❌ |

**総差分**: 596個
**一致率**: 9.8%

---

## 根本原因の特定

### 1. 全角アルファベットが処理されない問題

#### 検証結果
- **入力**: List[35]に「ａ」（全角アルファベット）が存在
- **期待される出力**: Subitem4として「ａ」が存在
- **実際の出力**: 「ａ」のタイトルを持つ要素が**0個** = 全く作成されていない

#### 詳細な1対1比較

**入力（test_input5.xml）:**
- List[32]: 「（オ）」（15番目/108個）
- List[33]: 「（（ア））」（16番目/108個）
- List[34]: 「（（イ））」（17番目/108個）
- List[35]: 「ａ」（18番目/108個） ← **これが処理されない**
- List[36]: 「ｂ」（19番目/108個）

**期待される出力（test_output5.xml）:**
```
Subitem4: ａ
  ← Subitem3: （（イ））
  ← Subitem2: （オ）
  ← Subitem1: ア
  ← Item: （１）
  ← Paragraph: (空)
```

**実際の出力（test_input5_converted.xml）:**
- ✅ 「（（ア））」: 1個存在（Subitem3の親タグ）
- ❌ 「（オ）」: 0個
- ❌ 「（（イ））」: 0個
- ❌ 「ａ」: 0個
- ❌ 「ｂ」: 0個
- ❌ 「ｃ」: 0個

### 2. 処理スキップの原因

**List[33]だけが処理されて、その後のList[34-36]が全てスキップされている。**

#### 考えられる原因
1. **先読み処理による誤判定**
   - List[31]（14番目）がColumn構造なし
   - その次のList[32]以降が「付随テキスト」として誤って処理されている可能性

2. **`processed_list_indices`による処理済みマーク**
   - 先読み処理で`processed_list_indices.add(i + 1)`などでマークされている

3. **ループの`continue`文**
   - 何らかの条件でスキップされている

---

## 問題箇所の特定

### `convert_paragraph_structure()`メソッドの問題

#### Phase 2: 先読み処理
```python
# ★ Phase 2: 先読み - 次のListがColumn構造なしか確認
if i + 1 < len(all_children) and all_children[i + 1].tag == 'List':
    next_list = all_children[i + 1]
    next_columns = self.extract_columns(next_list)
    
    if not next_columns:
        # Column構造なし = 補足テキスト
        # 現在作成した要素に追加
        ...
        # 処理済みとしてマーク
        processed_list_indices.add(i + 1)
```

**問題点**:
- `processed_list_indices.add(i + 1)`で次のList要素を処理済みとマーク
- しかし、その次のList[i+2]以降も連続でスキップされている可能性

---

## 次のアクション

1. **`processed_list_indices`のチェック**
   - どのList要素が処理済みとマークされているか確認

2. **ループのデバッグ出力追加**
   - 各List要素がどの条件で処理/スキップされているか記録

3. **先読み処理の見直し**
   - 複数のColumn構造なしListが連続する場合の処理を修正

---

## 補足: 全角アルファベットの認識

全角アルファベット「ａ」「ｂ」「ｃ」は、`get_hierarchy_level()`で**level=6と正しく認識されている**。

```python
# テスト結果
✅ 「ａ」: level=6, 半角=False, 全角=True, 統合=True
✅ 「ｂ」: level=6, 半角=False, 全角=True, 統合=True
✅ 「ｃ」: level=6, 半角=False, 全角=True, 統合=True
```

したがって、問題は階層レベル判定ではなく、**変換処理のループロジック**にある。

---

**以上**

