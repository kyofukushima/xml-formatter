#!/bin/bash
###############################################################################
# パイプライン共通関数ライブラリ
#
# 用途: パイプラインスクリプトで共通的に使用する関数を提供します
#
# 使用方法:
#   source "$(dirname "${BASH_SOURCE[0]}")/lib/pipeline_common.sh"
#
###############################################################################

# 色付き出力用の定義
if [ -z "${RED:-}" ]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[1;33m'
  BLUE='\033[0;34m'
  NC='\033[0m'  # No Color
fi

###############################################################################
# 出力関数
###############################################################################

# 使用方法を表示
print_usage() {
  local script_name="$1"
  local description="$2"
  local usage_text="$3"
  
  cat << EOF
${YELLOW}========================================${NC}
${description}
${YELLOW}========================================${NC}

使用方法:
  ${script_name} ${usage_text}

EOF
}

# ステップヘッダーを表示
print_step() {
  local step_name="$1"
  echo ""
  echo -e "${GREEN}===============================================${NC}"
  echo -e "${GREEN}${step_name}${NC}"
  echo -e "${GREEN}===============================================${NC}"
}

# エラーメッセージを表示
print_error() {
  echo -e "${RED}[エラー] $1${NC}" >&2
}

# 成功メッセージを表示
print_success() {
  echo -e "${GREEN}[成功] $1${NC}"
}

# 情報メッセージを表示
print_info() {
  echo -e "${YELLOW}[情報] $1${NC}"
}

# 警告メッセージを表示
print_warning() {
  echo -e "${YELLOW}[警告] $1${NC}"
}

###############################################################################
# バリデーション関数
###############################################################################

# 引数の数をチェック
validate_argument_count() {
  local actual_count=$1
  local required_count=$2
  
  if [ $actual_count -lt $required_count ]; then
    return 1
  fi
  return 0
}

# モード値を検証
validate_mode() {
  local mode="$1"
  
  if [ "$mode" != "all" ] && [ "$mode" != "step" ]; then
    return 1
  fi
  return 0
}

# ディレクトリの存在確認
validate_directory() {
  local dir_path="$1"
  
  if [ ! -d "$dir_path" ]; then
    return 1
  fi
  return 0
}

# XMLファイルの存在確認
validate_xml_files() {
  local dir_path="$1"
  
  if [ -z "$(find "$dir_path" -maxdepth 1 -name '*.xml' -type f)" ]; then
    return 1
  fi
  return 0
}

# スクリプトファイルの存在確認
validate_script_file() {
  local script_path="$1"
  
  if [ ! -f "$script_path" ]; then
    return 1
  fi
  return 0
}

###############################################################################
# ディレクトリ操作関数
###############################################################################

# 出力ディレクトリを作成
create_output_directory() {
  local output_dir="$1"
  
  if [ ! -d "$output_dir" ]; then
    print_info "出力フォルダを作成します: $output_dir"
    mkdir -p "$output_dir"
    print_success "出力フォルダを作成しました"
  fi
}

# 中間ファイルディレクトリを作成
create_intermediate_directory() {
  local intermediate_dir="$1"
  
  if [ ! -d "$intermediate_dir" ]; then
    print_info "中間ファイル保存用のフォルダを作成します: $intermediate_dir"
    mkdir -p "$intermediate_dir"
  fi
}

# パスを絶対パスに変換
normalize_path() {
  local path="$1"
  echo "$(cd "$path" && pwd)"
}

###############################################################################
# ファイル操作関数
###############################################################################

# XMLファイル一覧を取得
get_xml_files() {
  local input_dir="$1"
  find "$input_dir" -maxdepth 1 -name '*.xml' -type f | sort
}

# ファイル名から拡張子を除く
get_filename_without_extension() {
  local filepath="$1"
  basename "$filepath" .xml
}

###############################################################################
# パイプライン実行関数
###############################################################################

# パース検証を実行
run_parse_validation() {
  local validation_script="$1"
  local input_file="$2"
  local report_file="$3"
  
  if [ ! -f "$validation_script" ]; then
    print_error "パース検証スクリプトが見つかりません: $validation_script"
    return 1
  fi
  
  print_info "パース検証を実行中..."
  echo "  検証対象ファイル: $input_file"
  echo "  パース検証レポート: $report_file"
  
  if python3 "$validation_script" "$input_file" > "$report_file" 2>&1; then
    if grep -q "SUCCESS:" "$report_file"; then
      print_success "パース検証が完了しました（正常）"
      return 0
    else
      print_error "パース検証で問題が検出されました"
      echo "パース検証レポートを確認してください: $report_file"
      return 1
    fi
  else
    print_error "パース検証スクリプトの実行中にエラーが発生しました"
    echo "パース検証レポートを確認してください: $report_file"
    return 1
  fi
}

# 変換スクリプトを実行
run_converter() {
  local converter_script="$1"
  local input_file="$2"
  local output_file="$3"
  local step_num="$4"
  local total_steps="$5"
  
  if [ ! -f "$converter_script" ]; then
    print_error "スクリプトが見つかりません: $converter_script"
    return 1
  fi
  
  local script_name=$(basename "$converter_script")
  print_info "[$step_num/$total_steps] $script_name を実行中..."
  
  if ! python3 "$converter_script" "$input_file" "$output_file" 2>/dev/null; then
    print_error "$script_name の実行中にエラーが発生しました。"
    echo "入力ファイル: $input_file"
    echo "出力ファイル: $output_file"
    return 1
  fi
  
  if [ ! -f "$output_file" ]; then
    print_error "出力ファイルが作成されませんでした: $output_file"
    return 1
  fi
  
  print_success "$script_name が完了しました"
  return 0
}

# 検証スクリプトを実行
run_validation() {
  local validation_script="$1"
  local original_file="$2"
  local final_file="$3"
  local report_file="$4"
  
  if [ ! -f "$validation_script" ]; then
    print_error "検証スクリプトが見つかりません: $validation_script"
    return 1
  fi
  
  print_info "検証スクリプトを実行中..."
  echo "  オリジナルファイル: $original_file"
  echo "  最終出力ファイル: $final_file"
  echo "  検証レポート: $report_file"
  
  if python3 "$validation_script" "$original_file" "$final_file" --report_file "$report_file" 2>/dev/null; then
    print_success "検証が完了しました"
    return 0
  else
    print_error "検証中にエラーが発生しました"
    echo "検証レポートを確認してください: $report_file"
    return 1
  fi
}

# パイプラインを実行
run_pipeline() {
  local script_dir="$1"
  local converters_ref="$2"  # 配列名を文字列で受け取る
  local current_input="$3"
  local intermediate_dir="$4"
  local filename_no_ext="$5"
  local mode="$6"
  
  # 配列を間接参照で取得
  local converters_array
  eval "converters_array=(\"\${${converters_ref}[@]}\")"
  
  local final_output=""
  local total_steps=${#converters_array[@]}
  
  for i in "${!converters_array[@]}"; do
    local converter_script="${converters_array[$i]}"
    local step_num=$((i + 1))
    
    local converter_path="$script_dir/$converter_script"
    local step_name=$(basename "$converter_script" .py)
    local output_file="$intermediate_dir/${filename_no_ext}-${step_name}.xml"
    
    if ! run_converter "$converter_path" "$current_input" "$output_file" "$step_num" "$total_steps"; then
      return 1
    fi
    
    current_input="$output_file"
    final_output="$output_file"
    
    # step モードの場合、各ステップ後に一時停止
    if [ "$mode" = "step" ] && [ $step_num -lt $total_steps ]; then
      read -p "次のステップに進むには Enter キーを押してください..."
      echo ""
    fi
  done
  
  echo "$final_output"
  return 0
}

###############################################################################
# レポート生成関数
###############################################################################

# パース検証レポートを表示
print_parse_validation_reports() {
  local intermediate_folder="$1"
  
  echo ""
  echo "パース検証レポート一覧:"
  find "$intermediate_folder" -name "*-parse_validation.txt" -type f | while read report_file; do
    echo "  - $report_file"
    if grep -q "SUCCESS:" "$report_file" 2>/dev/null; then
      echo -e "    ${GREEN}[成功] XML構文が正しいです${NC}"
    elif grep -q "ERROR:" "$report_file" 2>/dev/null; then
      echo -e "    ${RED}[エラー] XML構文エラーが検出されました${NC}"
    fi
  done
}

# 検証レポートを表示
print_validation_reports() {
  local intermediate_folder="$1"
  
  echo ""
  echo "検証レポート一覧:"
  find "$intermediate_folder" -name "*-validation_report.txt" -type f | while read report_file; do
    echo "  - $report_file"
    if grep -q "❌ Error:" "$report_file" 2>/dev/null; then
      echo -e "    ${RED}[要確認] テキスト欠落が検出されました${NC}"
    elif grep -q "✅ Success:" "$report_file" 2>/dev/null; then
      echo -e "    ${GREEN}[成功] テキスト内容が一致しています${NC}"
    fi
  done
}

# 完了メッセージを表示
print_completion_message() {
  local output_folder="$1"
  local intermediate_folder="$2"
  
  print_step "処理完了"
  echo "すべてのファイルの処理が完了しました。"
  echo ""
  echo "出力ファイル一覧:"
  ls -lh "$output_folder"/*.xml 2>/dev/null || echo "  (出力ファイルなし)"
  
  print_parse_validation_reports "$intermediate_folder"
  print_validation_reports "$intermediate_folder"
  
  echo ""
  print_success "パイプライン処理と検証が完了しました"
}












