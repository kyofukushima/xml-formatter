# 処理ロジック

非エンジニア向けに、`scripts/run_pipeline.sh` が行う処理の流れをまとめました。スクリプト自体の中身ではなく、「どのようにXMLが整形されていくか」を説明します。処理後は中間ファイルと検証レポートが `output/intermediate_files/` に保存されます。

---

## 対応範囲（階層）
- Article（条）から Paragraph／Item を経て Subitem1〜Subitem10 まで段階的に整形します。
- 先頭の前処理で、Sentenceの並びをListへ整理しやすい形に整えます。
- 処理完了後に「構文検証（validate_xml）」と「テキスト内容検証（compare_xml_text_content）」を実施します。

---

## 処理手順と例
単体テストのサンプル（`scripts/test_data/unit_tests/...`）から代表例を抜粋しています。前が「入力」、後が「期待される出力」です。

### 1. 前処理（Sentence→List化の下準備）
**目的**: Paragraph内で2個目以降に現れる「ラベル＋全角スペース＋本文」のSentenceを List に分割し、後続の処理が番号・ラベルを拾いやすくします。ラベルは括弧付き数字に限らず、`label_config.json` の定義（括弧カタカナ・丸数字・ローマ数字・学年／科目ラベルなど）にマッチすれば対象です。  
**例**: `preprocess_non_first_sentence_to_list/04_pattern4_multiple_paragraph_sentences`

入力:
```xml
<Paragraph>
  <ParagraphSentence>
    <Sentence Num="1">これはParagraphNumの直後のParagraphSentenceです。変換されません。</Sentence>
  </ParagraphSentence>
  …
  <ParagraphSentence>
    <Sentence Num="1">（１）　2個目のParagraphSentenceの内容</Sentence>
  </ParagraphSentence>
  …
  <ParagraphSentence>
    <Sentence Num="1">（２）　3個目のParagraphSentenceの内容</Sentence>
  </ParagraphSentence>
</Paragraph>
```

出力（2個目以降を List に変換）:
```xml
<Paragraph>
  <ParagraphSentence>…</ParagraphSentence>
  <List>
    <ListSentence>
      <Column Num="1"><Sentence Num="1">（１）</Sentence></Column>
      <Column Num="2"><Sentence Num="1">2個目のParagraphSentenceの内容</Sentence></Column>
    </ListSentence>
  </List>
  …
  <List>
    <ListSentence>
      <Column Num="1"><Sentence Num="1">（２）</Sentence></Column>
      <Column Num="2"><Sentence Num="1">3個目のParagraphSentenceの内容</Sentence></Column>
    </ListSentence>
  </List>
</Paragraph>
```

### 2. Article の処理
**目的**: 1つの Article に複数条がまとまっている場合、見出しの「第○」を手掛かりに分割し、条番号を正規化します。  
**例**: `article_focused/02_pattern2_split`

入力（1つのArticleに「第１」「第２」が並ぶ）:
```xml
<Article Num="999999999">
  <ArticleTitle>第１</ArticleTitle>
  …（第1条本文）
  <List>
    <ListSentence>
      <Column Num="1"><Sentence Num="1">第２</Sentence></Column>
      <Column Num="2"><Sentence Num="1">第2条の内容です。</Sentence></Column>
    </ListSentence>
  </List>
</Article>
```

出力（条ごとに分割し番号を振り直す）:
```xml
<Article Num="1">…第1条の内容…</Article>
<Article Num="2">
  <ArticleTitle>第２</ArticleTitle>
  <Paragraph>…第2条の内容…</Paragraph>  <!-- Listの2列目（本文側）は ParagraphSentence に格納される -->
</Article>
```

### 3. Paragraph の処理
**目的**: 段落番号の補完や段落内のSentence配置を整えます。  
**例**: `convert_paragraph_step1/01_no_paragraph_num`

入力（段落番号タグ欠落）:
```xml
<Paragraph Num="1">
  <ParagraphSentence>
    <Sentence>ParagraphNumがありません。</Sentence>
  </ParagraphSentence>
</Paragraph>
```

出力（`ParagraphNum` を補完）:
```xml
<Paragraph Num="1">
  <ParagraphNum/>
  <ParagraphSentence>
    <Sentence>ParagraphNumがありません。</Sentence>
  </ParagraphSentence>
</Paragraph>
```

### 4. Item〜Subitem10 の処理
Itemから下位のSubitemを、番号付きテキストを手掛かりに分割・入れ子化します。

- **Item 変換（`convert_item_step0.py`）**  
  Paragraph内のList要素をItem要素に変換します。Columnが2つ以上で、1列目がラベル（「（１）」「（ア）」など）の場合、Item要素に変換します。
  ```xml
  入力: Paragraph内の List に「（１）」「ColumnありListの内容」
  出力: <Item Num="1"><ItemTitle>（１）</ItemTitle>…</Item>
  ```

- **Subitem1 生成（`convert_subitem1_step0.py`）**  
  Item内のList要素をSubitem1要素に変換します。「（ア）」「（イ）」のようなカタカナ付き列を Subitem1 に昇格させます。
  ```xml
  入力: Item内の List に「（ア）」「ColumnありListの内容」
  出力: <Subitem1 Num="1"><Subitem1Title>（ア）</Subitem1Title>…</Subitem1>
  ```

- **Subitem2〜Subitem10（`convert_subitem2_step0.py` 〜 `convert_subitem10_step0.py`）**  
  各階層のList要素を下位のSubitem要素に変換します。Subitem1内のList → Subitem2、Subitem2内のList → Subitem3、というように、Subitem10まで段階的に処理します。処理の考え方はSubitem1と同じで、ラベルパターンに合わせて入れ子を深くしていきます。

### 5. 検証ステップ
- **構文検証**: `validate_xml.py` でXML構文をチェックし、結果を `...-parse_validation.txt` に保存。
- **テキスト内容検証**: 元XMLと最終XMLでテキストが欠落していないかを `compare_xml_text_content.py` で確認し、`...-validation_report.txt` に保存。

---

## ラベル定義（設定JSON）
ラベル判定は `scripts/config/label_config.json` の正規表現と優先度に従います。主なパターンと例（「ラベル＋全角スペース＋本文」を分割するときに利用）は次のとおりです。

- **条の区切り**: `第１` / `第2` / `第一` / `第二`
- **学年ラベル**: 先頭が全角カッコ系（〔【［（ など）で始まり、`第○学年` を含む  
  - 単一学年: `〔第１学年〕`（数字は全角/半角/漢数字を許容）  
  - 二学年並列: `〔第１学年及び第２学年〕`（「及び」で連結）  
  - 下位のItem/Subitemへ誤分割しないよう特殊扱い
- **科目ラベル**: `〔医療と社会〕` / `【医療と社会】` / `［善悪の判断，自律，自由と責任］`
- **括弧数字（Item/Subitem）**: `(1)` / `（１）` / `（一）` / `（i）` `（ii）` `（ｉ）`
- **括弧カタカナ・アルファベット**: `（ア）` `（イ）`、`（a）` `（ａ）`（大文字小文字、全角半角も含む）
- **二重括弧系（下位階層用）**: `((1))` / `（（１））` / `（（一））` / `((a))` / `（（ア））`
- **丸数字**: `①` `②` …（Subitem3 など）
- **括弧なしカタカナ**: `ア` `イ` …（Subitem1/2 レベル）
- **括弧なしアルファベット**: `A` / `a`（全角も定義）
- **括弧なし数字**: `1` / `１`
- **その他**: 空文字はラベル扱いしない／該当なしは `unknown`

優先度は設定ファイルの列挙順で適用され、同一パターンは同一階層として扱います。学年・科目ラベルは誤分割を防ぐため特殊扱いです。

---

## 参考テストデータ
- 前処理: `unit_tests/preprocess_non_first_sentence_to_list/04_pattern4_multiple_paragraph_sentences`
- Article: `unit_tests/article_focused/02_pattern2_split`
- Paragraph: `unit_tests/convert_paragraph_step3/` および `unit_tests/convert_paragraph_step4/`
- Item: `unit_tests/convert_item_step0/`
- Subitem1: `unit_tests/convert_subitem1_step0/01_process1_branch1_column_list`
- Subitem2〜10: `unit_tests/convert_subitem2_step0/` 〜 `unit_tests/convert_subitem10_step0/`

これらを確認すると、実際の入力がどのように整形されるかを具体的に把握できます。